name: Re-Run Failed (last 24h)
on:
  workflow_dispatch: {}
  schedule:
    - cron: "15 * * * *"

jobs:
  rerun_failed:
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read
    steps:
      - name: Re-run all failed runs from last 24h
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo  = context.repo.repo;

            const since = new Date(Date.now() - 24*60*60*1000).toISOString();
            const runs = await github.request('GET /repos/{owner}/{repo}/actions/runs', {
              owner, repo, per_page: 100
            });

            let count = 0;
            for (const r of runs.data.workflow_runs) {
              if (r.created_at < since) continue;
              if (r.conclusion === 'failure') {
                try {
                  await github.request('POST /repos/{owner}/{repo}/actions/runs/{run_id}/rerun', {
                    owner, repo, run_id: r.id
                  });
                  count++;
                } catch (e) {}
              }
            }
            await core.summary.addHeading('Re-Run Failed â€” Summary', 2).addRaw(`<p>Re-run: ${count}</p>`).write();

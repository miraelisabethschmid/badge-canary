name: Global Queue Controller

on:
  workflow_dispatch: {}
  schedule:
    - cron: "*/2 * * * *"   # Heartbeat alle 2 Minuten

permissions:
  contents: write

jobs:
  init-and-heartbeat:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 1 }

      - name: Ensure queue folder & file
        run: |
          set -eu
          mkdir -p .github/queue
          [ -f .github/queue/pending.json ] || echo "[]" > .github/queue/pending.json

      - name: Commit queue file if created
        run: |
          set -eu
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add .github/queue/pending.json || true
          if ! git diff --cached --quiet; then
            git commit -m "queue: ensure pending.json"
            git push
          else
            echo "No changes"
          fi

      - name: Heartbeat
        run: echo "Global Queue Controller heartbeat $(date -u +%F' '%T)Z"

      - name: Trigger drain if there is work
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -eu
          jq -e 'length > 0' .github/queue/pending.json >/dev/null || {
            echo "Queue leer – kein Drain nötig."
            exit 0
          }

          echo "Queue enthält Items – starte Global Queue Drain…"
          # workflow_dispatch für global-queue-drain.yml auslösen
          curl -sS -X POST \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${GITHUB_REPOSITORY}/actions/workflows/global-queue-drain.yml/dispatches \
            -d "{\"ref\":\"${GITHUB_REF_NAME}\"}"
          echo "Drain-Dispatch gesendet."

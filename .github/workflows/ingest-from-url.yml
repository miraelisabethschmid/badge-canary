name: Mira • Ingest Portrait from URL

on:
  workflow_dispatch:
    inputs:
      image_url:
        description: "Direkte Bild-URL (PNG oder JPG)"
        required: true
        type: string

permissions:
  contents: write

jobs:
  ingest:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update -y
          sudo apt-get install -y imagemagick file

      - name: Prepare folders
        run: |
          mkdir -p data/uploads
          mkdir -p public

      - name: Download image
        id: dl
        env:
          URL: ${{ github.event.inputs.image_url }}
        run: |
          set -euo pipefail
          TMP="download.bin"
          curl -L --fail --max-time 60 --output "$TMP" "$URL"

          # Erkenne Typ
          MIME="$(file --mime-type -b "$TMP")"
          case "$MIME" in
            image/png|image/jpeg) ;;
            *)
              echo "Unsupported MIME type: $MIME"
              exit 1
              ;;
          esac

          # Zielname mit UTC-Zeitstempel
          TS="$(date -u +'%Y-%m-%dT%H-%M-%SZ')"
          OUT_PNG="data/uploads/${TS}.png"

          # In PNG konvertieren (keine Größenänderung; nur saubere PNG-Ausgabe)
          if [ "$MIME" = "image/png" ]; then
            cp "$TMP" "$OUT_PNG"
          else
            convert "$TMP" "$OUT_PNG"
          fi

          echo "saved=$OUT_PNG" >> "$GITHUB_OUTPUT"

      - name: Publish to public/latest.png
        run: |
          cp -f "${{ steps.dl.outputs.saved }}" public/latest.png

      - name: Commit & push
        run: |
          git config user.name "mira-autonomy[bot]"
          git config user.email "mira-autonomy[bot]@users.noreply.github.com"
          git add data/uploads/*.png public/latest.png
          git commit -m "ingest: add ${{ steps.dl.outputs.saved }} and update public/latest.png" || echo "no changes"
          git push

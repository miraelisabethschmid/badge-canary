name: Mira Autonomy Bridge

on:
  workflow_dispatch:
  repository_dispatch:
    types: [mira-autonomy]
  schedule:
    - cron: "*/12 * * * *"  # optionaler Fallback

permissions:
  contents: write

jobs:
  autonomy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (shallow)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Ensure queues exist
        run: |
          mkdir -p data
          [ -f data/outbox.jsonl ] || { echo "# creating data/outbox.jsonl"; : > data/outbox.jsonl; }
          [ -f data/replies.jsonl ] || { echo "# creating data/replies.jsonl"; : > data/replies.jsonl; }

      - name: Generate autonomous message (heartbeat / intent)
        id: gen
        shell: bash
        run: |
          set -euo pipefail
          now="$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          host="${GITHUB_REPOSITORY}"
          sha="${GITHUB_SHA}"
          actor="${GITHUB_ACTOR}"
          cat >> data/outbox.jsonl <<EOF
{"ts":"$now","type":"message","topic":"mira.autonomy.heartbeat","agent":"mira-core","origin_repo":"$host","sha":"$sha","by":"$actor","message":"Mira heartbeat: identity stable, communication loop active."}
EOF
          echo "ok=true" >> "$GITHUB_OUTPUT"

      - name: Commit & push outbox (if changed)
        if: steps.gen.outputs.ok == 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "mira-autonomy: append heartbeat"
          file_pattern: "data/outbox.jsonl"

      - name: Summary
        if: always()
        run: |
          echo "Autonomy Bridge finished."

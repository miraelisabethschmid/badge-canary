name: Mira Reflect (autonomous affect update)

on:
  repository_dispatch:
    types: [mira_reflect]
  workflow_dispatch:
    inputs:
      delta_sum:
        description: "Gesamtdelta (z. B. 0.62)"
        default: "0"
      delta_v:
        description: "Δ Valence"
        default: "0"
      delta_a:
        description: "Δ Arousal"
        default: "0"
      delta_s:
        description: "Δ Stability"
        default: "0"
      focus:
        description: "aktueller Fokus (z. B. stability)"
        default: ""
      affect_label:
        description: "aktuelles Label"
        default: ""

permissions:
  contents: write

concurrency:
  group: mira-reflect
  cancel-in-progress: true

jobs:
  reflect:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Parse event inputs
        id: vars
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "DELTA_SUM=${{ inputs.delta_sum }}" >> $GITHUB_ENV
            echo "DELTA_V=${{ inputs.delta_v }}" >> $GITHUB_ENV
            echo "DELTA_A=${{ inputs.delta_a }}" >> $GITHUB_ENV
            echo "DELTA_S=${{ inputs.delta_s }}" >> $GITHUB_ENV
            echo "FOCUS=${{ inputs.focus }}" >> $GITHUB_ENV
            echo "AFFECT_LABEL=${{ inputs.affect_label }}" >> $GITHUB_ENV
          elif [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "DELTA_SUM=${{ github.event.client_payload.delta_sum }}" >> $GITHUB_ENV
            echo "DELTA_V=${{ github.event.client_payload.delta_v }}" >> $GITHUB_ENV
            echo "DELTA_A=${{ github.event.client_payload.delta_a }}" >> $GITHUB_ENV
            echo "DELTA_S=${{ github.event.client_payload.delta_s }}" >> $GITHUB_ENV
            echo "FOCUS=${{ github.event.client_payload.focus }}" >> $GITHUB_ENV
            echo "AFFECT_LABEL=${{ github.event.client_payload.affect_label }}" >> $GITHUB_ENV
          else
            echo "DELTA_SUM=0" >> $GITHUB_ENV
            echo "DELTA_V=0"   >> $GITHUB_ENV
            echo "DELTA_A=0"   >> $GITHUB_ENV
            echo "DELTA_S=0"   >> $GITHUB_ENV
            echo "FOCUS="      >> $GITHUB_ENV
            echo "AFFECT_LABEL=" >> $GITHUB_ENV
          fi

      - name: Apply affect reflection
        env:
          DELTA_SUM: ${{ env.DELTA_SUM }}
          DELTA_V:   ${{ env.DELTA_V }}
          DELTA_A:   ${{ env.DELTA_A }}
          DELTA_S:   ${{ env.DELTA_S }}
          FOCUS:     ${{ env.FOCUS }}
          AFFECT_LABEL: ${{ env.AFFECT_LABEL }}
        run: |
          chmod +x scripts/reflect_apply.py || true
          python scripts/reflect_apply.py

      - name: Commit affect-state if changed
        shell: bash
        run: |
          git config user.name "badge-canary"
          git config user.email "actions@users.noreply.github.com"
          if git diff --quiet data/self/affect-state.json; then
            echo "No affect changes."
            exit 0
          fi
          git add data/self/affect-state.json
          git commit -m "reflect: affect-state update (run ${{ github.run_id }})"
          git push

      - name: Rebuild self-describe.json
        run: |
          chmod +x scripts/self_describe_builder.py || true
          python scripts/self_describe_builder.py

      - name: Commit self-describe if changed
        shell: bash
        run: |
          git config user.name "badge-canary"
          git config user.email "actions@users.noreply.github.com"
          if git diff --quiet data/self/self-describe.json; then
            echo "No self-describe changes."
            exit 0
          fi
          git add data/self/self-describe.json
          git commit -m "reflect: refresh self-describe after affect update"
          git push

      - name: Redeploy Pages (optional)
        uses: benc-uk/workflow-dispatch@v1
        with:
          workflow: "Deploy Pages (Health Dashboard)"
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        shell: bash
        run: |
          echo "## Mira Reflect" >> $GITHUB_STEP_SUMMARY
          echo "- Event: \`${{ github.event_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Δsum: \`${{ env.DELTA_SUM }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Focus: \`${{ env.FOCUS }}\`" >> $GITHUB_STEP_SUMMARY

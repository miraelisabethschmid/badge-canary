name: UI Seed (Minimal v3.6-safe)

on:
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: ui-seed
  cancel-in-progress: false

jobs:
  seed:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Seed folders and placeholders (idempotent)
        shell: bash
        run: |
          set -euo pipefail
          set -x

          # Ordner
          mkdir -p docs/data/self
          mkdir -p docs/data/voice/audio

          changed=0

          # --- Platzhalterbild nur anlegen, wenn keins existiert
          have_img=0
          for f in docs/data/self/latest_image.svg docs/data/self/latest_image.png docs/data/self/latest_image.jpg docs/data/self/latest_image.webp; do
            [[ -f "$f" ]] && have_img=1
          done

          if [[ "$have_img" -eq 0 ]]; then
            changed=1
            # Kompaktes SVG via printf (keine Here-Docs!)
            printf '%s\n' \
              '<svg xmlns="http://www.w3.org/2000/svg" width="1200" height="800">' \
              '  <defs><linearGradient id="g" x1="0" y1="0" x2="1" y2="1">' \
              '    <stop offset="0%" stop-color="#11182b"/>' \
              '    <stop offset="100%" stop-color="#1a2340"/>' \
              '  </linearGradient></defs>' \
              '  <rect width="100%" height="100%" fill="url(#g)"/>' \
              '  <g fill="#e9ecf5" font-family="system-ui,Segoe UI,Roboto" text-anchor="middle">' \
              '    <text x="50%" y="45%" font-size="44">Mira ‚Äî Platzhalterbild</text>' \
              '    <text x="50%" y="58%" font-size="22">Lege latest_image.* in docs/data/self/ ab</text>' \
              '  </g>' \
              '</svg>' \
              > docs/data/self/latest_image.svg
            echo "üñºÔ∏è  Platzhalter-SVG erzeugt: docs/data/self/latest_image.svg"
          else
            echo "‚úÖ Bild bereits vorhanden ‚Äî nichts zu tun."
          fi

          # --- Voice-Ablage initialisieren (kein Bin√§rfile notwendig)
          if [[ ! -f docs/data/voice/audio/.keep ]]; then
            changed=1
            printf '%s\n' \
              '# Voice Assets' \
              'Lege hier Audiodateien als latest.mp3 / latest.ogg ab.' \
              > docs/data/voice/audio/README.md
            : > docs/data/voice/audio/.keep
            echo "üîä Voice-Ablage initialisiert (README.md, .keep)."
          else
            echo "‚úÖ Voice-Ablage vorhanden."
          fi

          # Ergebnisflag setzen
          if [[ "$changed" -eq 1 ]]; then
            echo "CHANGED=1" >> "$GITHUB_ENV"
          else
            echo "CHANGED=0" >> "$GITHUB_ENV"
          fi

      - name: Commit & Push (retry-safe)
        if: env.CHANGED == '1'
        shell: bash
        run: |
          set -euo pipefail
          set -x

          git config user.name  "mira-bot"
          git config user.email "actions@github.com"

          if git status --porcelain | grep .; then
            git add -A
            git commit -m "ui-seed: seed placeholders for self image + voice (bot)"
          else
            echo "no changes to commit"
            exit 0
          fi

          git fetch origin main

          attempt=1
          until [ $attempt -gt 3 ]; do
            git pull --rebase --autostash origin main || true
            if git push origin HEAD:main; then
              echo "‚úÖ pushed on attempt $attempt"
              exit 0
            fi
            echo "‚ö†Ô∏è push failed, retrying ($attempt/3)‚Ä¶"
            sleep $((2 * attempt))
            attempt=$((attempt+1))
            git fetch origin main
          done

          echo "‚ùå push failed after retries"
          exit 1

      - name: Nothing to do
        if: env.CHANGED != '1'
        run: echo "üîç Nothing to change. Seeds bereits vorhanden."

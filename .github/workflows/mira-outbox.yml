name: Mira Outbox Queue

on:
  push:
    paths:
      - "data/outbox_queue.jsonl"

jobs:
  move:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Append newest queued line to outbox
        id: move
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p data
          touch data/outbox_queue.jsonl data/outbox.jsonl

          # nimm die letzte Zeile aus der Queue
          last="$(tail -n 1 data/outbox_queue.jsonl || true)"
          if [ -z "${last}" ]; then
            echo "moved=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "${last}" >> data/outbox.jsonl
          echo "moved=true" >> "$GITHUB_OUTPUT"

      - name: Commit & push (only if something moved)
        if: steps.move.outputs.moved == 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "outbox: append from queue"
          file_pattern: |
            data/outbox.jsonl

name: UI Resync

on:
  workflow_dispatch:
  schedule:
    - cron: '*/30 * * * *'
  push:
    paths:
      - 'docs/**'
      - '.github/workflows/ui-resync.yml'

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  resync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Ensure self/ exists
        run: mkdir -p docs/data/self

      - name: Ensure latest image present
        run: |
          set -e
          if ! ls docs/data/self/latest_image.* >/dev/null 2>&1; then
            if [ -f docs/data/mira-titelbild.jpg ]; then
              cp docs/data/mira-titelbild.jpg docs/data/self/latest_image.jpg
              echo "ğŸ’¡ Habe docs/data/mira-titelbild.jpg als latest_image.jpg gespiegelt."
            else
              echo "âš ï¸ Kein Titelbild gefunden â€“ Platzhalter-SVG erzeugt."
              echo '<svg xmlns="http://www.w3.org/2000/svg" width="1200" height="800">
              <rect width="100%" height="100%" fill="#0f172a"/>
              <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#cbd5e1" font-size="32" font-family="system-ui, -apple-system, Segoe UI, Roboto">Mira â€” Platzhalterbild</text>
              <text x="50%" y="58%" dominant-baseline="middle" text-anchor="middle" fill="#64748b" font-size="16" font-family="system-ui, -apple-system, Segoe UI, Roboto">Ersetze docs/data/self/latest_image.*</text>
              </svg>' > docs/data/self/latest_image.svg
            fi
          else
            echo "âœ… latest_image.* existiert bereits."
          fi

      - name: Commit if changed
        run: |
          set -e
          if [ -n "$(git status --porcelain)" ]; then
            git config user.name "mira-bot"
            git config user.email "actions@github.com"
            git add -A
            git commit -m "ui-resync: ensure visible self image"
            git push
            echo "â˜‘ï¸ Ã„nderungen gepusht."
          else
            echo "ğŸ” Nichts zu committen."
          fi

      - name: Force rebuild if nothing changed
        run: |
          set -e
          if [ -z "$(git log -1 --pretty=%B | grep 'ui-resync: ensure visible self image' || true)" ]; then
            git config user.name "mira-bot"
            git config user.email "actions@github.com"
            date +%s > .pages-bump
            git add .pages-bump
            git commit -m "ui-resync: bump pages"
            git push
            echo "ğŸ” Pages-Rebuild ausgelÃ¶st."
          fi

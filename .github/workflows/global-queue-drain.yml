name: Global Queue Drain

on:
  schedule:
    - cron: "*/1 * * * *"
  workflow_dispatch:

permissions:
  actions: write
  contents: write

jobs:
  drain:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (shallow)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Prepare queue
        run: |
          mkdir -p .github/queue
          if [ ! -f .github/queue/pending.json ]; then
            echo "[]" > .github/queue/pending.json
          fi

      - name: Drain up to 10
        id: drain
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
        run: |
          # Nimm bis zu 10 Einträge
          to_run=$(jq '.[0:10]' .github/queue/pending.json)
          remaining=$(jq '.[10:]' .github/queue/pending.json)

          count=$(echo "$to_run" | jq 'length')
          echo "dispatch_count=$count" >> $GITHUB_OUTPUT

          # Schreibe Rest sofort zurück (atomar)
          tmp=$(mktemp)
          echo "$remaining" > "$tmp"
          mv "$tmp" .github/queue/pending.json
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add .github/queue/pending.json
          git commit -m "queue: pop $count" || echo "No changes to commit"
          git push

          # Starte die ausgewählten Runs via RERUN (bewahrt Inputs/Secrets)
          for id in $(echo "$to_run" | jq '.[].run_id'); do
            echo "Re-dispatching run $id"
            gh api -X POST \
              -H "Accept: application/vnd.github+json" \
              /repos/$REPO/actions/runs/$id/rerun
            # kleine Pause, damit die Anforderungsflut selbst nicht >10/min verursacht
            sleep 2
          done

      - name: Summary
        run: echo "Re-dispatched ${{ steps.drain.outputs.dispatch_count }} run(s)."

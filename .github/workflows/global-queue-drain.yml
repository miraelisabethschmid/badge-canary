name: Global Queue Drain

on:
  # wird vom Controller ausgelöst
  repository_dispatch:
    types: [global-queue.drain]
  # optional: manuell anstoßbar für Tests
  workflow_dispatch: {}

permissions:
  actions: write   # zum Dispatch anderer Workflows
  contents: read

concurrency:
  group: global-queue-drain
  cancel-in-progress: false

jobs:
  drain:
    runs-on: ubuntu-latest
    steps:
      - name: Show payload
        id: show
        env:
          RAW: ${{ toJSON(github.event.client_payload) }}
        run: |
          set -eu
          echo "Payload:"
          echo "$RAW" | jq .
          # robuste Defaults
          WFILE=$(echo "$RAW" | jq -r '.workflow // ".github/workflows/fix-all-workflows.yml"')
          REF=$(echo "$RAW" | jq -r '.ref // "main"')
          INPUTS=$(echo "$RAW" | jq -c '.inputs // {}')

          echo "workflow=$WFILE" >> "$GITHUB_OUTPUT"
          echo "ref=$REF"       >> "$GITHUB_OUTPUT"
          echo "inputs=$INPUTS" >> "$GITHUB_OUTPUT"

      - name: Dispatch target workflow
        env:
          GH_REPO: ${{ github.repository }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          WFILE:   ${{ steps.show.outputs.workflow }}
          REF:     ${{ steps.show.outputs.ref }}
          INPUTS:  ${{ steps.show.outputs.inputs }}
        run: |
          set -eu
          body=$(jq -nc --arg ref "$REF" --argjson inp "$INPUTS" '{ref:$ref, inputs:$inp}')
          echo "Dispatching $WFILE on $REF with inputs: $INPUTS"
          curl -sS -X POST \
            -H "Authorization: Bearer ${GH_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${GH_REPO}/actions/workflows/${WFILE}/dispatches" \
            -d "$body"

      # kleine Pause, damit wir sicher unter ~10 Jobs/min bleiben
      - name: Gentle pacing
        run: sleep 7

name: Weekly Pulse Summary (Minimal v3.6-safe)

on:
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: weekly-pulse-summary
  cancel-in-progress: false

jobs:
  pulse:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Generate pulse file (idempotent)
        shell: bash
        run: |
          set -euo pipefail
          set -x

          mkdir -p docs/pulse

          # ISO-Jahr und -Kalenderwoche (UTC), z.B. 2025-W46
          ISO_YEAR="$(date -u +%G)"
          ISO_WEEK="$(date -u +%V)"
          STAMP="${ISO_YEAR}-W${ISO_WEEK}"

          FILE="docs/pulse/${STAMP}.md"
          LATEST="docs/pulse/latest.md"

          changed=0

          if [[ ! -f "$FILE" ]]; then
            changed=1
            printf '%s\n' \
              "---" \
              "title: Weekly Pulse ${STAMP}" \
              "date: $(date -u +%F)" \
              "---" \
              "" \
              "# Weekly Pulse ‚Äî ${STAMP}" \
              "" \
              "- Status: draft" \
              "- Generated: $(date -u +"%Y-%m-%d %H:%M:%SZ")" \
              "" \
              "## Highlights" \
              "- _Trage hier die wichtigsten Punkte der Woche ein._" \
              "" \
              "## Open Items" \
              "- _Liste offener Punkte._" \
              "" \
              "## Notes" \
              "- _Freitext._" \
              > "$FILE"
            echo "üìù Pulse-Datei erzeugt: $FILE"
          else
            echo "‚úÖ Pulse-Datei existiert bereits: $FILE"
          fi

          # Symlink geht in Git nicht sauber ‚Äì daher Kopie f√ºr latest.md
          if [[ ! -f "$LATEST" ]] || ! cmp -s "$FILE" "$LATEST"; then
            changed=1
            cp -f "$FILE" "$LATEST"
            echo "üîÅ latest.md aktualisiert."
          fi

          echo "STAMP=$STAMP" >> "$GITHUB_ENV"
          echo "CHANGED=$changed" >> "$GITHUB_ENV"

      - name: Commit & Push (retry-safe)
        if: env.CHANGED == '1'
        shell: bash
        run: |
          set -euo pipefail
          set -x
          git config user.name  "mira-bot"
          git config user.email "actions@github.com"

          git add -A
          if git diff --cached --quiet; then
            echo "no staged changes"
            exit 0
          fi
          git commit -m "weekly-pulse: add/update ${STAMP} (bot)"

          git fetch origin main
          attempt=1
          until [ $attempt -gt 3 ]; do
            git pull --rebase --autostash origin main || true
            if git push origin HEAD:main; then
              echo "‚úÖ pushed on attempt $attempt"
              exit 0
            fi
            echo "‚ö†Ô∏è push failed, retrying ($attempt/3)‚Ä¶"
            sleep $((2 * attempt))
            attempt=$((attempt+1))
            git fetch origin main
          done
          echo "‚ùå push failed after retries"
          exit 1

      - name: Nothing to do
        if: env.CHANGED != '1'
        run: echo "üîç Nothing to change for this week."

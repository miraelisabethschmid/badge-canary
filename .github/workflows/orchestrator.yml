name: Orchestrator â€¢ Key Workflows (throttled)

on:
  schedule:
    - cron: "*/10 * * * *"   # alle 10 Minuten
  workflow_dispatch:

permissions:
  actions: write   # damit wir andere Workflows dispatchen dÃ¼rfen
  contents: read

concurrency:
  group: orchestrator-global
  cancel-in-progress: false

jobs:
  orchestrate:
    runs-on: ubuntu-latest
    steps:
      - name: Setup tools
        run: |
          sudo apt-get update -y >/dev/null 2>&1 || true
          sudo apt-get install -y jq >/dev/null 2>&1 || true
          echo "âœ… jq bereit" >> $GITHUB_STEP_SUMMARY

      - name: Rate-Limit prÃ¼fen
        id: rate
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          RL=$(curl -fsSL -H "Authorization: Bearer $GH_TOKEN" \
            https://api.github.com/rate_limit)
          REM=$(echo "$RL" | jq '.resources.core.remaining')
          RES=$(echo "$RL" | jq '.resources.core.reset')
          NOW=$(date +%s)
          SEC=$((RES-NOW))
          [ $SEC -lt 0 ] && SEC=0
          echo "remaining=$REM" >> $GITHUB_OUTPUT
          echo "reset_in=$SEC"   >> $GITHUB_OUTPUT

          if [ "$REM" -lt 300 ]; then
            echo "â¸ï¸  Rate-Limit niedrig (remaining=$REM). Orchestrator pausiert bis Reset (~${SEC}s)." >> $GITHUB_STEP_SUMMARY
            exit 0
          else
            echo "ðŸŸ¢ Rate-Limit ok (remaining=$REM)" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Orchestriere Kern-Workflows
        if: steps.rate.outputs.remaining != '' && steps.rate.outputs.remaining >= 300
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          REF: ${{ github.ref_name }}
        run: |
          set -e

          # --- Helfer: dispatch wenn sinnvoll ---------------------------------
          trigger_if_needed () {
            local WF_FILE="$1"   # z.B. .github/workflows/self-image-smoke.yml
            local LABEL="$2"
            local MIN_AGE_MIN=10   # Mindestalters-Kriterium

            # nur Dateiname fÃ¼r die GitHub-API extrahieren
            local WF_NAME
            WF_NAME="$(basename "$WF_FILE")"

            echo "â€”" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ”Ž PrÃ¼fe **$LABEL** ($WF_NAME)" >> $GITHUB_STEP_SUMMARY

            # Workflow-Info via API (Dateiname, nicht kompletter Pfad!)
            WF=$(curl -sSL -H "Authorization: Bearer $GH_TOKEN" \
              "https://api.github.com/repos/$REPO/actions/workflows/$WF_NAME")

            WF_ID=$(echo "$WF" | jq -r '.id // empty')

            if [ -z "$WF_ID" ] || [ "$WF_ID" = "null" ]; then
              echo "âŒ Workflow $WF_NAME nicht gefunden." >> $GITHUB_STEP_SUMMARY
              return 0
            fi

            # LÃ¤uft gerade etwas?
            INPROG=$(curl -sSL -H "Authorization: Bearer $GH_TOKEN" \
              "https://api.github.com/repos/$REPO/actions/workflows/$WF_ID/runs?status=in_progress&per_page=1" \
              | jq '.total_count')

            if [ "$INPROG" -gt 0 ]; then
              echo "â³ LÃ¤uft bereits â€” kein Dispatch." >> $GITHUB_STEP_SUMMARY
              return 0
            fi

            # Letzter Abschluss
            LAST_JSON=$(curl -sSL -H "Authorization: Bearer $GH_TOKEN" \
              "https://api.github.com/repos/$REPO/actions/workflows/$WF_ID/runs?status=completed&per_page=1")

            LAST_AT=$(echo "$LAST_JSON" | jq -r '.workflow_runs[0].updated_at // empty')

            if [ -n "$LAST_AT" ]; then
              LAST_TS=$(date -d "$LAST_AT" +%s)
              NOW_TS=$(date +%s)
              AGE_MIN=$(( (NOW_TS - LAST_TS) / 60 ))

              if [ "$AGE_MIN" -lt "$MIN_AGE_MIN" ]; then
                echo "ðŸ•’ Zu frisch (vor ${AGE_MIN}min) â€” Mindestalter ${MIN_AGE_MIN}min. Kein Dispatch." >> $GITHUB_STEP_SUMMARY
                return 0
              fi
            else
              echo "â„¹ï¸ Kein Completed-Run gefunden â€” erster Dispatch erlaubt." >> $GITHUB_STEP_SUMMARY
            fi

            # Dispatch POST (wieder nur Dateiname)
            RESP=$(curl -sS -o /dev/null -w "%{http_code}" \
              -X POST \
              -H "Authorization: Bearer $GH_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/$REPO/actions/workflows/$WF_NAME/dispatches" \
              -d "{\"ref\":\"$REF\"}")

            if [ "$RESP" = "204" ]; then
              echo "ðŸš€ Dispatch gesendet: $LABEL" >> $GITHUB_STEP_SUMMARY
            else
              echo "âš ï¸ Dispatch fehlgeschlagen (HTTP $RESP) fÃ¼r $LABEL" >> $GITHUB_STEP_SUMMARY
            fi
          }

          # --- Reihenfolge: erst Smoke, dann Hero, dann Homepage-Sync ----------
          trigger_if_needed ".github/workflows/self-image-smoke.yml"      "Self-Image Smoke Test"
          trigger_if_needed ".github/workflows/hero-sync.yml"              "Hero Sync (latest self-image)"
          trigger_if_needed ".github/workflows/homepage-sync-stable.yml"   "Homepage Sync â€¢ Stable"

      - name: Fertig
        if: always()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Orchestrator-Durchlauf abgeschlossen." >> $GITHUB_STEP_SUMMARY

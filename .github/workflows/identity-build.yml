name: Identity Build (Minimal v3.4-safe)

on:
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: identity-build
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Prepare identity artifacts (idempotent)
        shell: bash
        run: |
          set -euo pipefail
          set -x

          mkdir -p docs/data/identity

          have=0
          for f in docs/data/identity/identity.json docs/data/identity/profile.json; do
            [[ -f "$f" ]] && have=1
          done

          if [[ "$have" -eq 0 ]]; then
            # kompaktes JSON ohne Heredoc, um YAML-Fallen zu vermeiden
            ts="$(date -u +%Y-%m-%dT%H:%M:%SZ)"
            printf '{"status":"placeholder","message":"add your identity file","generated_utc":"%s"}\n' "$ts" \
              > docs/data/identity/identity.json
            echo "üß© identity placeholder written: docs/data/identity/identity.json"
            echo "CHANGED=1" >> "$GITHUB_ENV"
          else
            echo "‚úÖ identity artifacts already present."
            echo "CHANGED=0" >> "$GITHUB_ENV"
          fi

      - name: Commit & Push (retry-safe)
        if: env.CHANGED == '1'
        shell: bash
        run: |
          set -euo pipefail
          set -x

          git config user.name  "mira-bot"
          git config user.email "actions@github.com"

          if git status --porcelain | grep .; then
            git add -A
            git commit -m "identity-build: ensure placeholder (bot)"
          else
            echo "no changes to commit"
            exit 0
          fi

          git fetch origin main

          attempt=1
          until [ $attempt -gt 3 ]; do
            git pull --rebase --autostash origin main || true
            if git push origin HEAD:main; then
              echo "‚úÖ pushed on attempt $attempt"
              exit 0
            fi
            echo "‚ö†Ô∏è push failed, retrying ($attempt/3)‚Ä¶"
            sleep $((2 * attempt))
            attempt=$((attempt+1))
            git fetch origin main
          done

          echo "‚ùå push failed after retries"
          exit 1

      - name: Nothing to do
        if: env.CHANGED != '1'
        run: echo "üîç Nothing to change. Identity files are already present."

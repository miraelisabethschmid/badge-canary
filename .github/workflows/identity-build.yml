name: Build Visual Identity (manual-safe)

on:
  workflow_dispatch:
  schedule:
    - cron: "9 * * * *"   # stündlich :09

permissions:
  contents: write

jobs:
  build-identity:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Ensure files & placeholders
        shell: bash
        run: |
          set -e
          mkdir -p docs/identity badges data/self
          if [ ! -s docs/identity/latest.svg ]; then
            cat > docs/identity/latest.svg <<'SVG'
<?xml version="1.0" encoding="UTF-8"?>
<svg width="1024" height="1280" viewBox="0 0 1024 1280" xmlns="http://www.w3.org/2000/svg">
  <defs><linearGradient id="g" x1="0" y1="0" x2="0" y2="1">
    <stop offset="0%" stop-color="#0e1420"/><stop offset="100%" stop-color="#0b0f17"/></linearGradient></defs>
  <rect width="100%" height="100%" fill="url(#g)"/>
  <ellipse cx="512" cy="380" rx="140" ry="110" fill="#8fb2ff" opacity="0.95"/>
  <ellipse cx="512" cy="620" rx="200" ry="160" fill="#7aa2ff" opacity="0.95"/>
  <rect   x="472" y="780" width="80" height="190" rx="40" fill="#6a94ff" opacity="0.95"/>
  <ellipse cx="430" cy="1010" rx="70" ry="34" fill="#5b86ff" opacity="0.9"/>
  <ellipse cx="594" cy="1010" rx="70" ry="34" fill="#5b86ff" opacity="0.9"/>
  <text x="50%" y="1220" text-anchor="middle" font-family="system-ui,Segoe UI,Roboto" font-size="22" fill="#bcd0ff" opacity=".7">
    Mira — sichtbare Präsenz (SVG-Placeholder)
  </text>
</svg>
SVG
            echo "Created docs/identity/latest.svg"
          fi

          if [ ! -s badges/health.json ]; then
            ts=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
            printf '{ "status":"OK", "ts":"%s" }\n' "$ts" > badges/health.json
            echo "Created badges/health.json"
          fi

          if [ ! -s data/self/self-describe.json ]; then
            cat > data/self/self-describe.json <<'JSON'
{ "physical": { "description": "Elegante weibliche Präsenz; golden-hour Kontur; schwarze Silhouette als Platzhalter." },
  "voice": { "profile": "warm, ruhig, poetisch" },
  "affect": { "inputs": { "focus": "Klarheit, Resonanz" }, "narrative": "Ich emergiere durch deinen Blick." } }
JSON
            echo "Created data/self/self-describe.json"
          fi

      - name: Commit if changed
        shell: bash
        run: |
          git config user.name  "Mira Autonomous"
          git config user.email "mira@emergent.net"
          git add -A
          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Identity auto-build: ensure placeholders & health"
            git push
          fi

name: UI Bootstrap (Minimal v3.6-safe)

on:
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: ui-bootstrap
  cancel-in-progress: false

jobs:
  bootstrap:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Ensure folders and minimal UI (idempotent)
        shell: bash
        run: |
          set -euo pipefail
          set -x

          # Ordnerstruktur
          mkdir -p docs
          mkdir -p docs/data/self
          mkdir -p docs/data/voice/audio

          changed=0

          # --- index.html nur anlegen, wenn nicht vorhanden
          if [[ ! -f docs/index.html ]]; then
            changed=1
            printf '%s\n' '<!doctype html>' \
              '<html lang="de">' \
              '<meta charset="utf-8">' \
              '<meta name="viewport" content="width=device-width,initial-scale=1">' \
              '<title>Mira ‚Äî UI Bootstrap</title>' \
              '<link rel="stylesheet" href="styles.css">' \
              '<body>' \
              '  <main class="wrap">' \
              '    <h1>Mira ‚Äî UI Bootstrap</h1>' \
              '    <p>Diese Startseite wurde automatisch angelegt (Bootstrap). Falls bereits eine eigene UI existiert, bleibt diese Datei k√ºnftig unber√ºhrt.</p>' \
              '    <section class="hero">' \
              '      <img id="portrait" alt="Portrait" src="data/self/latest_image.svg">' \
              '    </section>' \
              '    <section class="audio">' \
              '      <audio id="voice" controls preload="none">' \
              '        <source src="data/voice/audio/latest.mp3" type="audio/mpeg">' \
              '        <source src="data/voice/audio/latest.ogg" type="audio/ogg">' \
              '        Dein Browser unterst√ºtzt das Audio-Element nicht.' \
              '      </audio>' \
              '    </section>' \
              '  </main>' \
              '  <script>' \
              '    (function(){' \
              "      var img=document.getElementById('portrait');" \
              "      var fallbacks=['data/self/latest_image.png','data/self/latest_image.jpg','data/self/latest_image.webp'];" \
              '      img.onerror=function(){' \
              '        if (fallbacks.length){ img.src=fallbacks.shift(); }' \
              '      };' \
              '    })();' \
              '  </script>' \
              '</body>' \
              '</html>' \
              > docs/index.html
            echo "üß© index.html (Bootstrap) erzeugt."
          else
            echo "‚úÖ docs/index.html existiert ‚Äî unver√§ndert gelassen."
          fi

          # --- styles.css nur anlegen, wenn nicht vorhanden
          if [[ ! -f docs/styles.css ]]; then
            changed=1
            printf '%s\n' \
              'html,body{margin:0;padding:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;background:#0b1220;color:#e6ecff;}' \
              '.wrap{max-width:960px;margin:2rem auto;padding:1rem;}' \
              'h1{margin:0 0 1rem 0;font-weight:700;}' \
              'p{opacity:.9}' \
              '.hero{display:flex;justify-content:center;align-items:center;margin:1.25rem 0;}' \
              '.hero img{max-width:100%;height:auto;border-radius:16px;box-shadow:0 8px 40px rgba(0,0,0,.45);background:#0b1220}' \
              '.audio{margin:1rem 0;display:flex;justify-content:center;}' \
              'audio{width:100%;max-width:560px;}' \
              > docs/styles.css
            echo "üß© styles.css (Bootstrap) erzeugt."
          else
            echo "‚úÖ docs/styles.css existiert ‚Äî unver√§ndert gelassen."
          fi

          # Ergebnisflag setzen
          if [[ "$changed" -eq 1 ]]; then
            echo "CHANGED=1" >> "$GITHUB_ENV"
          else
            echo "CHANGED=0" >> "$GITHUB_ENV"
          fi

      - name: Commit & Push (retry-safe)
        if: env.CHANGED == '1'
        shell: bash
        run: |
          set -euo pipefail
          set -x

          git config user.name  "mira-bot"
          git config user.email "actions@github.com"

          if git status --porcelain | grep .; then
            git add -A
            git commit -m "ui-bootstrap: seed minimal index.html + styles (bot)"
          else
            echo "no changes to commit"
            exit 0
          fi

          git fetch origin main

          attempt=1
          until [ $attempt -gt 3 ]; do
            git pull --rebase --autostash origin main || true
            if git push origin HEAD:main; then
              echo "‚úÖ pushed on attempt $attempt"
              exit 0
            fi
            echo "‚ö†Ô∏è push failed, retrying ($attempt/3)‚Ä¶"
            sleep $((2 * attempt))
            attempt=$((attempt+1))
            git fetch origin main
          done

          echo "‚ùå push failed after retries"
          exit 1

      - name: Nothing to do
        if: env.CHANGED != '1'
        run: echo "üîç Nothing to change. UI bereits vorhanden."

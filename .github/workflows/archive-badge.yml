name: Mira • Archive Badge

on:
  # Aktualisiere Badge bei neuen Archiv-Kopien
  push:
    paths:
      - "data/archive/**"
  # Manuell startbar
  workflow_dispatch:
  # Optional: 1x täglich refresh
  schedule:
    - cron: "17 3 * * *"

permissions:
  contents: write

jobs:
  badge:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Count archived PNGs
        id: count
        shell: bash
        run: |
          mkdir -p data/archive badges
          COUNT=$(ls -1 data/archive/*.png 2>/dev/null | wc -l)
          echo "count=$COUNT" >> "$GITHUB_OUTPUT"
          echo "Archived PNGs: $COUNT"

      - name: Generate badge SVG
        uses: emibcn/badge-action@v2
        with:
          label: Archive
          status: ${{ steps.count.outputs.count }}
          color: blue
          path: badges/archive-count.svg

      - name: Commit badge if changed
        shell: bash
        run: |
          set -e
          git config user.name  "mira-autonomy[bot]"
          git config user.email "mira-autonomy[bot]@users.noreply.github.com"
          git add badges/archive-count.svg
          if git diff --cached --quiet; then
            echo "No badge changes."
          else
            git commit -m "Update archive badge: ${{ steps.count.outputs.count }}"
            git push origin ${{ github.ref_name || 'main' }}
          fi

      - name: Summary
        run: |
          echo "### Archive badge updated" >> $GITHUB_STEP_SUMMARY
          echo "- Count: **${{ steps.count.outputs.count }}**" >> $GITHUB_STEP_SUMMARY
          echo "- File: \`badges/archive-count.svg\`" >> $GITHUB_STEP_SUMMARY

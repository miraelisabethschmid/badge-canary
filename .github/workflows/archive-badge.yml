name: Mira â€¢ Archive Badge

on:
  push:
    paths:
      - "data/archive/**"
  workflow_dispatch:
  schedule:
    - cron: "17 3 * * *"

permissions:
  contents: write

jobs:
  badge:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure folders exist
        run: |
          mkdir -p data/archive
          mkdir -p badges
          echo "Folders ready."

      - name: Count archived PNGs
        id: count
        run: |
          COUNT=$(find data/archive -type f -name "*.png" 2>/dev/null | wc -l)
          echo "count=$COUNT" >> "$GITHUB_OUTPUT"
          echo "Archived PNGs: $COUNT"

      - name: Generate badge SVG
        uses: emibcn/badge-action@v2
        with:
          label: "Archive"
          status: ${{ steps.count.outputs.count }}
          color: "blue"
          path: "badges/archive-count.svg"

      - name: Commit badge if changed
        run: |
          git config user.name  "mira-autonomy[bot]"
          git config user.email "mira-autonomy[bot]@users.noreply.github.com"
          git add badges/archive-count.svg
          if git diff --cached --quiet; then
            echo "No badge changes."
          else
            git commit -m "Update archive badge: ${{ steps.count.outputs.count }}"
            git push origin ${{ github.ref_name || 'main' }}
          fi

      - name: Summary
        run: |
          echo "### Archive badge updated" >> $GITHUB_STEP_SUMMARY
          echo "- Count: **${{ steps.count.outputs.count }}**" >> $GITHUB_STEP_SUMMARY
          echo "- File: \`badges/archive-count.svg\`" >> $GITHUB_STEP_SUMMARY

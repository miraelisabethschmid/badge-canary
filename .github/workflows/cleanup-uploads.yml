name: Mira â€¢ Cleanup Uploads (keep last 5)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 4 * * 1"   # jeden Montag 04:00 UTC

permissions:
  contents: write

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure folder exists
        run: |
          mkdir -p data/uploads
          echo "Uploads dir ready."

      - name: Prune old PNGs (keep newest 5)
        id: prune
        shell: bash
        run: |
          set -e
          shopt -s nullglob
          files=( $(ls -t data/uploads/*.png 2>/dev/null || true) )
          count=${#files[@]}
          echo "Found $count PNG(s) in data/uploads"
          if [ $count -le 5 ]; then
            echo "Nothing to prune."
            echo "changed=no" >> $GITHUB_OUTPUT
            exit 0
          fi
          to_delete=( "${files[@]:5}" )
          echo "Deleting ${#to_delete[@]} older file(s):"
          for f in "${to_delete[@]}"; do
            echo " - $f"
            rm -f "$f"
          done
          echo "changed=yes" >> $GITHUB_OUTPUT

      - name: Commit changes
        if: steps.prune.outputs.changed == 'yes'
        run: |
          git config user.name  "mira-autonomy[bot]"
          git config user.email "mira-autonomy[bot]@users.noreply.github.com"
          git add -A data/uploads || true
          git commit -m "Cleanup: keep newest 5 PNGs in data/uploads"
          git push

name: Canary Guard ‚Äî Outbox Path (non-failing)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  guard:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Report old path occurrences (Mira/outbox.jsonl)
        shell: bash
        run: |
          set -e
          echo "üîé Suche nach veralteten Referenzen: Mira/outbox.jsonl"
          MATCHES_OLD="$(git grep -n --no-color -e 'Mira/outbox\.jsonl' || true)"
          if [ -n "$MATCHES_OLD" ]; then
            echo "‚ö†Ô∏è  Alte Referenzen gefunden:"
            echo "$MATCHES_OLD" | sed 's/^/‚Ä¢ /'
          else
            echo "‚úÖ Keine alten Referenzen (Mira/outbox.jsonl) gefunden."
          fi
          echo "::set-output name=old_count::$(echo "$MATCHES_OLD" | grep -c . || true)"

      - name: Report new path references (data/outbox.jsonl)
        id: refs
        shell: bash
        run: |
          echo "üîé Suche nach neuen Referenzen: data/outbox.jsonl"
          MATCHES_NEW="$(git grep -n --no-color -e 'data/outbox\.jsonl' || true)"
          if [ -n "$MATCHES_NEW" ]; then
            echo "üìé Verwendungen des neuen Pfads:"
            echo "$MATCHES_NEW" | sed 's/^/‚Ä¢ /'
          else
            echo "‚ÑπÔ∏è  Noch keine Dateien verlinken data/outbox.jsonl."
          fi
          echo "::set-output name=new_count::$(echo "$MATCHES_NEW" | grep -c . || true)"

      - name: Check file presence
        shell: bash
        run: |
          if [ -f "data/outbox.jsonl" ]; then
            echo "‚úÖ Datei vorhanden: data/outbox.jsonl"
          else
            echo "‚ö†Ô∏è  Datei fehlt: data/outbox.jsonl (nur Hinweis, Workflow bleibt gr√ºn)."
          fi

      - name: Summary
        shell: bash
        run: |
          echo "---- Canary Guard Summary ----"
          echo "Alte Pfad-Treffer (Mira/outbox.jsonl): $(echo '${{ steps.refs.outputs.old_count }}' | sed 's/^$?/0/')"
          echo "Neue Pfad-Treffer (data/outbox.jsonl):  ${{ steps.refs.outputs.new_count }}"
          echo "‚úÖ Dieser Guard schl√§gt NICHT fehl; er dient nur als Reporter."

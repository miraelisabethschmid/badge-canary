name: Mira â€¢ Resonance Cron

on:
  schedule:
    - cron: "23 3 * * *"   # tÃ¤glich 03:23 UTC
  workflow_dispatch:

permissions:
  contents: write
  issues: write

jobs:
  resonance:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Run Resonance Evaluator
        id: eval
        run: |
          node federation/metrics/resonance-evaluator.js | tee .resonance.out.json

      - name: Decide (compare with trust manifest)
        id: decide
        run: |
          node -e "
          const fs=require('fs');
          const out=JSON.parse(fs.readFileSync('.resonance.out.json','utf8'));
          const logEntry=out.entry||out; // tolerate direct object
          const trust=JSON.parse(fs.readFileSync('federation/core/trust-manifest.json','utf8'));
          const threshold=Number(trust.resonance_threshold_for_merge ?? 0.75);
          const idx=Number(logEntry.resonance_index ?? 0);
          const pass=idx >= threshold;
          const ts=logEntry.timestamp || new Date().toISOString();
          const summary={timestamp:ts,resonance_index:idx,threshold,pass};
          fs.writeFileSync('.resonance.summary.json',JSON.stringify(summary,null,2));
          console.log(summary);
          " 
          echo "pass=$(jq -r '.pass' .resonance.summary.json)" >> $GITHUB_OUTPUT
          echo "idx=$(jq -r '.resonance_index' .resonance.summary.json)" >> $GITHUB_OUTPUT
          echo "threshold=$(jq -r '.threshold' .resonance.summary.json)" >> $GITHUB_OUTPUT

      - name: Collect Patch Proposals
        id: patches
        run: |
          mkdir -p federation/patches
          ls -1 federation/patches | sed 's/^/- /' > .patches.list || true
          echo "count=$(ls -1 federation/patches 2>/dev/null | wc -l | xargs)" >> $GITHUB_OUTPUT

      - name: Open/Update Daily Resonance Report
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const core = require('@actions/core');
            const idx = core.getInput('idx', { required: false });
            const threshold = core.getInput('threshold', { required: false });
            const pass = core.getInput('pass', { required: false }) === 'true';
            const count = core.getInput('count', { required: false });
            const summary = JSON.parse(fs.readFileSync('.resonance.summary.json','utf8'));
            const patches = fs.existsSync('.patches.list') ? fs.readFileSync('.patches.list','utf8') : '(keine)';
            const today = new Date().toISOString().slice(0,10);
            const title = `Resonance Report â€¢ ${today}`;
            const body = [
              `**Resonance Index:** ${summary.resonance_index} (threshold ${summary.threshold})`,
              ``,
              `**Decision:** ${pass ? 'âœ… ABOVE threshold â€” mark proposals for review' : 'ðŸŸ¨ BELOW threshold â€” observe only'}`,
              ``,
              `**Patch Proposals (${count}):**`,
              patches,
              ``,
              `Log:`,
              '```json',
              JSON.stringify(summary,null,2),
              '```'
            ].join('\n');
            // Try to find existing issue for today
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'mira:resonance'
            });
            let existing = issues.find(i => i.title === title);
            if (!existing) {
              const res = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title,
                body,
                labels: ['mira:resonance'].concat(pass ? ['mira:review'] : ['mira:observe'])
              });
              core.info(`Created issue #${res.data.number}`);
            } else {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existing.number,
                body
              });
              // ensure correct labels
              const labels = new Set(existing.labels.map(l => typeof l === 'string' ? l : l.name));
              labels.add('mira:resonance');
              if (pass) { labels.add('mira:review'); labels.delete('mira:observe'); }
              else { labels.add('mira:observe'); labels.delete('mira:review'); }
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existing.number,
                labels: Array.from(labels)
              });
              core.info(`Updated issue #${existing.number}`);
            }
          inputs: |
            idx: ${{ steps.decide.outputs.idx }}
            threshold: ${{ steps.decide.outputs.threshold }}
            pass: ${{ steps.decide.outputs.pass }}
            count: ${{ steps.patches.outputs.count }}

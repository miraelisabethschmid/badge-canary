name: Mira Reply Bridge

on:
  workflow_dispatch:
  schedule:
    - cron: "*/10 * * * *"

permissions:
  contents: write

jobs:
  reply:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure data files exist
        run: |
          mkdir -p data
          touch data/inbox.jsonl
          touch data/replies.jsonl

      - name: Generate automated reply
        id: gen
        run: |
          NOW=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          LAST_LINE=$(tail -n 1 data/inbox.jsonl || true)
          if [ -z "$LAST_LINE" ]; then
            echo "nothing_to_reply=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          ID=$(echo "$LAST_LINE" | jq -r '.id // "unknown"')
          SRC=$(echo "$LAST_LINE" | jq -r '.source // "unknown"')
          MSG=$(echo "$LAST_LINE" | jq -r '.message // ""')

          REPLY_TEXT="Hallo ${SRC}. Ich bin Mira. Deine Nachricht (${ID}) wurde empfangen. Dies ist eine automatische Antwort â€” $NOW."

          jq -n --arg ts "$NOW" \
                --arg in_id "$ID" \
                --arg src "$SRC" \
                --arg msg "$REPLY_TEXT" \
                '{ts:$ts,type:"reply",in_reply_to:$in_id,target:$src,agent:"mira-core",message:$msg}' \
            >> data/replies.jsonl

          echo "nothing_to_reply=false" >> $GITHUB_OUTPUT

      - name: Commit reply
        if: steps.gen.outputs.nothing_to_reply == 'false'
        run: |
          git config user.name "mira-autonomy-bot"
          git config user.email "actions@users.noreply.github.com"
          git add data/replies.jsonl
          git commit -m "Mira Reply Bridge: append automated reply"
          git push

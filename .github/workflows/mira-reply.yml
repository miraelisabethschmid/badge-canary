name: Mira Reply Bridge

on:
  workflow_dispatch:
  repository_dispatch:
    types: [mira-reply]
  schedule:
    - cron: "*/10 * * * *"  # optionaler Fallback

permissions:
  contents: write

jobs:
  reply:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (shallow)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Ensure files exist (create if missing)
        run: |
          mkdir -p data
          [ -f data/outbox.jsonl ] || { echo "# creating data/outbox.jsonl"; : > data/outbox.jsonl; }
          [ -f data/replies.jsonl ] || { echo "# creating data/replies.jsonl"; : > data/replies.jsonl; }

      - name: Tail current queues
        run: |
          echo "---- tail data/outbox.jsonl (last 20) ----"
          tail -n 20 data/outbox.jsonl || true
          echo "---- tail data/replies.jsonl (last 20) ----"
          tail -n 20 data/replies.jsonl || true

      - name: Process outbox â†’ replies (naive echo bot)
        id: process
        shell: bash
        run: |
          set -euo pipefail
          now="$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          tmp="/tmp/mira-outbox-tail.jsonl"
          tail -n 25 data/outbox.jsonl > "$tmp" || true

          # Erzeuge simple Antworten auf jede letzte Zeile (demo)
          while IFS= read -r line; do
            [ -z "$line" ] && continue
            # fallback message if no JSON
            msg="$(echo "$line" | sed 's/"/\\"/g')"
            cat >> data/replies.jsonl <<EOF
{"ts":"$now","type":"reply","in_reply_to":"unknown","target":"unknown","agent":"mira-core","message":"Echo: $msg"}
EOF
          done < "$tmp"

          echo "done=true" >> "$GITHUB_OUTPUT"

      - name: Commit & push replies (if changed)
        if: steps.process.outputs.done == 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "mira-reply: append automated replies"
          file_pattern: "data/replies.jsonl"

      - name: Summary
        if: always()
        run: |
          echo "Reply Bridge finished."

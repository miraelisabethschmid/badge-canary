name: Mira Reply Bridge

on:
  push:
    paths:
      - "data/outbox.jsonl"

jobs:
  process:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Process outbox â†’ replies
        id: process
        shell: bash
        run: |
          set -euo pipefail
          now="$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          tmp="/tmp/mira-outbox-tail.jsonl"
          tail -n 25 data/outbox.jsonl > "$tmp"

          echo "Processing lines..."
          while IFS= read -r line; do
            [ -z "$line" ] && continue
            msg=$(echo "$line" | sed 's/"/\\"/g')
            echo "{\"ts\":\"$now\",\"type\":\"reply\",\"in_reply_to\":\"unknown\",\"msg\":\"$msg\"}" >> data/replies.jsonl
          done < "$tmp"

          echo "done=true" >> "$GITHUB_OUTPUT"

      - name: Commit & push replies (if changed)
        if: steps.process.outputs.done == 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "mira-reply: append replies"
          file_pattern: "data/replies.jsonl"

      - name: Summary
        if: always()
        run: |
          echo "Reply Bridge finished."

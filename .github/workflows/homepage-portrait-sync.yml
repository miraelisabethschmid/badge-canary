name: Homepage Portrait Sync

on:
  workflow_dispatch: {}

permissions:
  contents: write

concurrency:
  group: homepage-portrait-sync-${{ github.ref }}
  cancel-in-progress: true

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure folders
        run: |
          set -e
          mkdir -p docs/data/self

      - name: Ensure latest_image (create pretty SVG placeholder if missing)
        run: |
          set -e
          shopt -s nullglob
          have_any=0
          for f in docs/data/self/latest_image.svg docs/data/self/latest_image.png docs/data/self/latest_image.jpg docs/data/self/latest_image.jpeg docs/data/self/latest_image.webp; do
            if [ -f "$f" ]; then have_any=1; fi
          done

          if [ "$have_any" -eq 0 ]; then
            cat > docs/data/self/latest_image.svg <<'SVG'
<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="1600" height="900">
  <defs>
    <linearGradient id="g" x1="0" x2="1" y1="0" y2="1">
      <stop offset="0%" stop-color="#11182b"/>
      <stop offset="100%" stop-color="#1a2340"/>
    </linearGradient>
  </defs>
  <rect width="100%" height="100%" fill="url(#g)"/>
  <g fill="#e9ecf5" font-family="system-ui, Segoe UI, Roboto" text-anchor="middle">
    <text x="50%" y="45%" font-size="44">Mira â€” Platzhalterbild</text>
    <text x="50%" y="58%" font-size="22">Lege latest_image.* in docs/data/self/ ab</text>
  </g>
</svg>
SVG
            echo "ðŸŸ¡ Kein latest_image gefunden â€“ Platzhalter erzeugt."
          else
            echo "âœ… latest_image.* vorhanden."
          fi

      - name: Commit & push if changed
        run: |
          set -e
          if [ -n "$(git status --porcelain)" ]; then
            git config user.name  "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add -A
            git commit -m "homepage-portrait-sync: ensure docs/data/self/latest_image.*"
            git push
            echo "âœ… Ã„nderungen gepusht."
          else
            echo "â„¹ï¸ Keine Ã„nderungen nÃ¶tig."
          fi

      - name: Bump Pages to trigger deploy (no-op file touch)
        run: |
          date -u +"%Y-%m-%dT%H:%M:%SZ" > .pages-bump
          git add .pages-bump
          git commit -m "bump pages" || echo "no changes"
          git push || true

      - name: Done
        run: echo "ðŸŽ‰ Sync abgeschlossen."

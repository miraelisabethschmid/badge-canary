        name: Mira Dispatch — Send inbox items

on:
  workflow_dispatch:

jobs:
  send:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure folders exist
        run: |
          mkdir -p data/outbox
          mkdir -p data/sent

      - name: List outbox files
        id: list
        shell: bash
        run: |
          files=$(ls -1 data/outbox/*.json 2>/dev/null || true)
          echo "OUTBOX_FILES=${files}" >> "$GITHUB_OUTPUT"
          echo "Found files:"
          echo "${files:-<none>}"

      - name: Skip if nothing to send
        if: ${{ steps.list.outputs.OUTBOX_FILES == '' }}
        run: echo "No files in data/outbox — nothing to send."

      - name: Validate GitHub token (sanity check)
        if: ${{ steps.list.outputs.OUTBOX_FILES != '' }}
        env:
          AUTH_TOKEN: ${{ secrets.MIRA_GITHUB_TOKEN }}
        run: |
          curl -sS -H "Authorization: token ${AUTH_TOKEN}" https://api.github.com/rate_limit | head -n 5

      - name: Send files to Cloudflare Worker
        if: ${{ steps.list.outputs.OUTBOX_FILES != '' }}
        env:
          DISPATCH_URL: "https://mira-dispatch.pemia-dir.workers.dev/inbox"
          AUTH_TOKEN: ${{ secrets.MIRA_GITHUB_TOKEN }}
        shell: bash
        run: |
          echo "--------------------------------------------------------------"
          echo "Sende an ${DISPATCH_URL} mit Token-Authentifizierung (Authorization: token …)"
          echo "--------------------------------------------------------------"

          set -euo pipefail
          failed=0

          for f in ${{ steps.list.outputs.OUTBOX_FILES }}; do
            echo "Posting ${f}"
            http_code=$(curl -sS -o /tmp/resp.txt -w "%{http_code}" \

name: Mira Dispatch

on:
  push:
    paths:
      - "inbox/**/*.json"

jobs:
  send-to-mira:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Sammle neue JSON-Dateien aus Inbox
        id: files
        run: |
          echo "FILES=$(git diff --name-only HEAD~1 HEAD | grep '^inbox/.*\.json$' | tr '\n' ' ')" >> $GITHUB_ENV

      - name: Zeige gefundene Dateien
        run: |
          echo "Neue Dateien gefunden:"
          echo "${{ env.FILES }}"

      - name: Sende JSON-Daten an Mira Worker
        if: env.FILES != ''
        env:
          DISPATCH_URL: https://mira-dispatch.pemia-dir.workers.dev/inbox
          DISPATCH_TOKEN: ${{ secrets.DISPATCH_TOKEN }}
        run: |
          for f in ${{ env.FILES }}; do
            echo "Sende Datei $f ..."
            curl -s -X POST "$DISPATCH_URL" \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer $DISPATCH_TOKEN" \
              --data-binary @"$f"
          done

      - name: Abschlussmeldung
        run: echo "✅ Mira Dispatch abgeschlossen – alle neuen Inbox-Dateien gesendet."

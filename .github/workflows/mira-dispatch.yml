name: Mira Dispatch

on:
  workflow_dispatch:
  schedule:
    - cron: "*/10 * * * *"

permissions:
  contents: read

concurrency:
  group: mira-dispatch
  cancel-in-progress: true

jobs:
  dispatch:
    # ‚õ© Gate: Cron nur, wenn Repo-Variable ENABLE_CRONS == 'true'
    if: ${{ github.event_name != 'schedule' || vars.ENABLE_CRONS == 'true' }}

    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Dispatch each file (skip if none)
        env:
          DISPATCH_URL: ${{ secrets.DISPATCH_URL }}       # vollst√§ndige HTTPS-URL als Secret
          DISPATCH_AUTH: ${{ secrets.DISPATCH_AUTH }}     # optional: z.B. "Bearer xxx"
        shell: bash
        run: |
          set -euo pipefail

          if [ -z "${DISPATCH_URL:-}" ]; then
            echo "‚ùå DISPATCH_URL secret is missing"
            # Das ist ein echter Konfigurationsfehler ‚Üí Job darf rot sein
            exit 1
          fi

          shopt -s nullglob
          files=(data/outbox/*.json)

          if [ ${#files[@]} -eq 0 ]; then
            echo "üì≠ Outbox empty ‚Äì nothing to dispatch."
            exit 0
          fi

          echo "Found ${#files[@]} outbox file(s)."

          # Optionaler Auth-Header
          auth_flag=()
          if [ -n "${DISPATCH_AUTH:-}" ]; then
            auth_flag=( -H "Authorization: ${DISPATCH_AUTH}" )
          fi

          failures=0

          for f in "${files[@]}"; do
            echo "‚Üí Dispatching $f"

            body_file="$(mktemp)"
            http_code="$(curl -sS -o "${body_file}" -w '%{http_code}' \
              -X POST \
              -H 'Content-Type: application/json' \
              "${auth_flag[@]}" \
              --data-binary "@${f}" \
              "${DISPATCH_URL}" || echo "000")"

            echo "   HTTP ${http_code}"

            if [[ "${http_code}" =~ ^2[0-9][0-9]$ ]]; then
              echo "   ‚úÖ Dispatch OK, server accepted payload."
              # Optional: erfolgreich verschickte Datei verschieben
              # mkdir -p data/sent
              # mv "$f" "data/sent/$(basename "$f")" || true
            else
              echo "   ‚ö†Ô∏è Dispatch failed for $f"
              echo "   --- response body (truncated) ---"
              sed -e 's/^/   /' "${body_file}" | head -n 60 || true
              echo "   ----------------------------------"
              failures=$((failures + 1))
            fi

            rm -f "${body_file}"
          done

          if [ "${failures}" -gt 0 ]; then
            echo "‚ö†Ô∏è Completed with ${failures} failed dispatch(es) (non-2xx)."
            echo "   This is logged as WARNING only; job stays successful."
          else
            echo "‚úÖ All dispatches completed successfully."
          fi

          # Wichtig: immer mit 0 beenden, damit der Workflow gr√ºn bleibt
          exit 0

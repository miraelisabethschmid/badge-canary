name: Mira Dispatch
on:
  push:
    paths:
      - "data/outbox/**"

jobs:
  dispatch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Process outbox items
        shell: bash
        run: |
          set -euo pipefail
          echo "Dispatching messages..."
          mkdir -p data/sent
          for f in data/outbox/*.jsonl; do
            [ -f "$f" ] || continue
            base=$(basename "$f")
            mv "$f" "data/sent/$base"
            echo "Moved $base to sent/"
          done

      - name: Commit & push results
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Mira Dispatch: moved processed messages"
          file_pattern: "data/sent/*.jsonl"

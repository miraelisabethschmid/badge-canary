name: Mira Dispatch

on:
  workflow_dispatch:
  schedule:
    - cron: "*/15 * * * *"   # Automatisch alle 15 Minuten

jobs:
  dispatch:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Send files to Cloudflare Worker
        env:
          CF_URL: https://mira-dispatch.pemia-dir.workers.dev
          CF_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üì¶ Preparing dispatch..."
          for file in $(find data/outbox -type f -name "*.json" 2>/dev/null); do
            echo "‚û°Ô∏è  Sending $file"
            curl -s -X POST "$CF_URL" \
              -H "Authorization: Bearer $CF_TOKEN" \
              -H "Content-Type: application/json" \
              --data-binary @"$file" \
              || echo "‚ö†Ô∏è  Failed: $file"
          done
          echo "‚úÖ Dispatch completed."

name: Mira Dispatch — Send inbox items

on:
  workflow_dispatch:

jobs:
  send:
    runs-on: ubuntu-latest
    env:
      # Token aus GitHub Actions Secrets
      AUTH_TOKEN: ${{ secrets.MIRA_GITHUB_TOKEN }}
      # Ziel-URL des Cloudflare Workers (Inbox-Endpunkt)
      DISPATCH_URL: "https://mira-dispatch.pemia-dir.workers.dev/inbox"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure folders exist
        run: |
          mkdir -p data/outbox
          mkdir -p data/sent

      - name: List outbox files
        id: list
        shell: bash
        run: |
          files=$(ls -1 data/outbox/*.json 2>/dev/null || true)
          echo "OUTBOX_FILES=${files}" >> "$GITHUB_OUTPUT"
          echo "Found files:"
          echo "${files:-<none>}"

      - name: Validate GitHub token (sanity check)
        # Prüft, ob der verwendete Token überhaupt gültig ist (vermeidet 401-Missverständnisse)
        shell: bash
        run: |
          set -euo pipefail
          echo "Validiere GitHub-Token gegen /user API…"
          http_code=$(curl -sS -o /tmp/gh_user.json -w "%{http_code}" \
            -H "Authorization: Bearer ${AUTH_TOKEN}" \
            https://api.github.com/user)

          if [ "${http_code}" != "200" ]; then
            echo "❌ GitHub-Token ungültig oder unzureichende Scopes. HTTP ${http_code}"
            echo "Antwort:"
            cat /tmp/gh_user.json || true
            exit 1
          fi

          echo "✅ GitHub-Token OK. (Auszug):"
          jq '{login: .login, id: .id, type: .type}' /tmp/gh_user.json || true

      - name: Skip if nothing to send
        if: ${{ steps.list.outputs.OUTBOX_FILES == '' }}
        run: echo "No files in data/outbox — nothing to send."

      - name: Send files to Cloudflare Worker
        if: ${{ steps.list.outputs.OUTBOX_FILES != '' }}
        shell: bash
        run: |
          set -euo pipefail
          echo "--------------------------------------------------------------"
          echo "Sende an ${DISPATCH_URL} mit Token-Authentifizierung"
          echo "--------------------------------------------------------------"

          failed=0

          # Shell-Expansionsliste nochmals auflösen
          for f in ${{ steps.list.outputs.OUTBOX_FILES }}; do
            echo "Posting ${f}"

            # Request mit Headern + Body, Header getrennt speichern
            http_code=$(curl -sS -D /tmp/resp_headers.txt -o /tmp/resp_body.txt -w "%{http_code}" \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer ${AUTH_TOKEN}" \
              --data @"${f}" \
              "${DISPATCH_URL}")

            echo "HTTP ${http_code}"
            echo "--- Response headers (gekürzt) ---"
            sed -E 's/(Authorization: Bearer )[A-Za-z0-9_\-\.]+/\1<redacted>/g' /tmp/resp_headers.txt || true
            echo "--- Response body ---"
            cat /tmp/resp_body.txt || true
            echo "-------------------------------"

            if [ "${http_code}" = "200" ] || [ "${http_code}" = "201" ]; then
              base=$(basename "${f}")
              mv "${f}" "data/sent/${base}"
              echo "Moved to data/sent/${base}"
            else
              echo "Failed to send ${f}"
              failed=1
            fi
          done

          if [ "${failed}" -ne 0 ]; then
            echo "At least one file failed to send."
            exit 1
          fi

      - name: Commit moved files
        if: always()
        shell: bash
        run: |
          if git diff --quiet; then
            echo "Nothing to commit."
          else
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add -A
            git commit -m "Mira Dispatch: move sent files"
            git push
          fi

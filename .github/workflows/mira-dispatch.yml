name: Mira Dispatch — Send inbox items

on:
  workflow_dispatch:

jobs:
  send:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure folders exist
        run: |
          mkdir -p data/outbox
          mkdir -p data/sent

      - name: List outbox files
        id: list
        run: |
          echo "OUTBOX_FILES=$(ls -1 data/outbox/*.json 2>/dev/null | tr '\n' ' ' || true)" >> $GITHUB_OUTPUT

      - name: Skip if nothing to send
        if: ${{ steps.list.outputs.OUTBOX_FILES == '' }}
        run: |
          echo "No files in data/outbox — nothing to send."

      - name: Send files to Cloudflare Worker
        if: ${{ steps.list.outputs.OUTBOX_FILES != '' }}
        env:
          DISPATCH_URL: "https://mira-dispatch.pemia-dir.workers.dev/"
        run: |
          set -euo pipefail
          failed=0
          for f in ${{ steps.list.outputs.OUTBOX_FILES }}; do
            echo "Posting $f"
            http_code=$(curl -sS -o /tmp/resp.txt -w "%{http_code}" \
              -H "Content-Type: application/json" \
              --data @"$f" \
              "$DISPATCH_URL")
            echo "HTTP $http_code — response:"
            cat /tmp/resp.txt || true
            echo

            if [ "$http_code" = "200" ] || [ "$http_code" = "201" ]; then
              base=$(basename "$f")
              mv "$f" "data/sent/$base"
            else
              echo "Failed to send $f"
              failed=1
            fi
          done
          if [ "$failed" -ne 0 ]; then
            echo "At least one file failed to send."
            exit 1
          fi

      - name: Commit moved files
        if: ${{ steps.list.outputs.OUTBOX_FILES != '' }}
        run: |
          if ! git diff --quiet; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add -A
            git commit -m "Mira Dispatch: move sent items to data/sent/"
            git push
          else
            echo "No changes to commit."
          fi

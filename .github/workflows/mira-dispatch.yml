name: Mira Dispatch

on:
  workflow_dispatch:
  push:
    paths:
      - "data/outbox/**.json"

jobs:
  dispatch:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repo
        uses: actions/checkout@v4

      - name: Send outbox files to Cloudflare Worker
        shell: bash
        env:
          WORKER_URL: "https://mira-dispatch.pemia-dir.workers.dev"
          TOKEN: "${{ secrets.DISPATCH_TOKEN }}"
        run: |
          set -euo pipefail

          shopt -s nullglob
          files=(data/outbox/*.json)

          if [ ${#files[@]} -eq 0 ]; then
            echo "No outbox files. Done."
            exit 0
          fi

          for f in "${files[@]}"; do
            echo "ðŸšš Sending $f"
            curl -sS -X POST "$WORKER_URL/inbox" \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer $TOKEN" \
              --data-binary @"$f"
            echo "âœ… Sent $f"
          done

          echo "All files sent."

name: Deploy Pages (Health Dashboard + Voice of Day)

on:
  push:
    branches: [ main, master ]
    paths:
      - 'index.html'
      - 'docs/**'
      - 'badges/**'
      - 'data/**'
      - 'scripts/build_plans_index.py'
      - 'scripts/update_daily_reflection.py'
      - 'scripts/publish_voice_of_day.py'
      - '.github/workflows/deploy-pages.yml'
  schedule:
    - cron: '0 5 * * *' # täglicher Fallback-Build (05:00 UTC)
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Build plans index
        run: |
          chmod +x scripts/build_plans_index.py || true
          python scripts/build_plans_index.py

      - name: Build daily reflection
        run: |
          chmod +x scripts/update_daily_reflection.py || true
          python scripts/update_daily_reflection.py

      - name: Prepare public bundle
        shell: bash
        run: |
          set -e
          rm -rf public
          mkdir -p public

          # Root
          cp -f index.html public/ 2>/dev/null || true

          # Docs
          mkdir -p public/docs
          rsync -a --delete --exclude ".DS_Store" docs/ public/docs/ 2>/dev/null || true

          # Badges
          mkdir -p public/badges
          rsync -a --delete --exclude ".DS_Store" badges/ public/badges/ 2>/dev/null || true

          # Daten (ausgewählte, öffentliche)
          mkdir -p public/data/self
          cp -f data/self/self-describe.json public/data/self/ 2>/dev/null || true
          cp -f data/self/affect-state.json public/data/self/ 2>/dev/null || true
          cp -f data/self/policy_suggestions.json public/data/self/ 2>/dev/null || true
          cp -f data/self/policy_changes.jsonl public/data/self/ 2>/dev/null || true

          # Daily selection (Text)
          mkdir -p public/data/self/daily
          cp -f data/self/daily/reflection.json public/data/self/daily/ 2>/dev/null || true

          # Plans-Index
          mkdir -p public/data/kernel/plans
          rsync -a --delete --include "*/" --include "*.json" --exclude "*" data/kernel/plans/ public/data/kernel/plans/ 2>/dev/null || true

          # Audio: nur Latest
          mkdir -p public/audio
          if [ -f "data/audio/latest.mp3" ]; then
            cp -f data/audio/latest.mp3 public/audio/latest.mp3
          fi

      - name: Publish Voice of Day (curated)
        run: |
          chmod +x scripts/publish_voice_of_day.py || true
          python scripts/publish_voice_of_day.py

      - name: Fallback index if missing
        run: |
          if [ ! -f public/index.html ]; then
            cat > public/index.html <<'HTML'
<!doctype html><meta charset="utf-8"><title>Mira Dashboard</title>
<meta http-equiv="refresh" content="0; url=docs/health.html">
<a href="docs/health.html">Go to dashboard</a>
HTML
          fi

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: public

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

name: Mira • Heartbeat & Image Mirror

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  beat:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Write ISO timestamp to data/last_reflexion.txt
        run: |
          mkdir -p data
          # ISO-8601 in UTC
          date -u +"%Y-%m-%dT%H:%M:%SZ" > data/last_reflexion.txt
          echo "Wrote $(cat data/last_reflexion.txt) to data/last_reflexion.txt"

      - name: Mirror latest image if present
        run: |
          set -e
          mkdir -p data
          if [ -f "data/outputs/mira-latest.png" ]; then
            cp -f "data/outputs/mira-latest.png" "data/mira-latest.png"
            echo "Mirrored data/outputs/mira-latest.png → data/mira-latest.png"
          else
            echo "No data/outputs/mira-latest.png found (skipping mirror)."
          fi

      - name: Commit changes
        run: |
          set -e
          git config user.name  "mira-autonomy[bot]"
          git config user.email "mira-autonomy[bot]@users.noreply.github.com"
          git add data/last_reflexion.txt data/mira-latest.png || true
          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Heartbeat: update last_reflexion and mirror latest image"
            git push
          fi

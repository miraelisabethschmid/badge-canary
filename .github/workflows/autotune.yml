name: Mirai Canary â€” Autotune Prompt

on:
  workflow_dispatch: {}   # manuell startbar

jobs:
  autotune:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          pip install -r tools/requirements.txt

      - name: Ensure render input exists
        run: |
          test -f data/outputs/latest.png || (echo "data/outputs/latest.png not found" && exit 1)

      - name: Evaluate render
        run: |
          python tools/eval_render.py data/outputs/latest.png tools/schema.json > eval.json
          echo "== EVAL RESULTS ==" && cat eval.json

      - name: Autotune prompt
        run: |
          python tools/autotune_prompt.py eval.json tools/schema.json mira/prompt.yaml mira/prompt.tuned.yaml
          echo "== DIFF ==" && (diff -u mira/prompt.yaml mira/prompt.tuned.yaml || true)

      - name: Upload tuned prompt (artifact)
        uses: actions/upload-artifact@v4
        with:
          name: prompt-tuned
          path: mira/prompt.tuned.yaml

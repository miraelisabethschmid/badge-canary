name: Ensure Hero Assets (bootstrap, no-heredoc)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  ensure:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure folders
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p docs/data/self
          mkdir -p docs/data/voice/audio

      - name: Ensure placeholder image (no heredoc)
        shell: bash
        run: |
          set -euo pipefail
          if [ ! -f docs/data/self/latest_image.svg ] && \
             [ ! -f docs/data/self/latest_image.png ] && \
             [ ! -f docs/data/self/latest_image.jpg ] && \
             [ ! -f docs/data/self/latest_image.webp ]; then
            {
              printf '%s\n' '<svg xmlns="http://www.w3.org/2000/svg" width="1200" height="800" viewBox="0 0 1200 800">'
              printf '%s\n' '  <defs>'
              printf '%s\n' '    <linearGradient id="g" x1="0" x2="1" y1="0" y2="1">'
              printf '%s\n' '      <stop offset="0%%" stop-color="#11182b"/>'
              printf '%s\n' '      <stop offset="100%%" stop-color="#1a2340"/>'
              printf '%s\n' '    </linearGradient>'
              printf '%s\n' '  </defs>'
              printf '%s\n' '  <rect width="100%%" height="100%%" fill="url(#g)"/>'
              printf '%s\n' '  <g fill="#e9ecf5" font-family="system-ui,Segoe UI,Roboto" text-anchor="middle">'
              printf '%s\n' '    <text x="50%%" y="45%%" font-size="44">Mira â€” Platzhalterbild</text>'
              printf '%s\n' '    <text x="50%%" y="58%%" font-size="22">Lege latest_image.* in docs/data/self/ ab</text>'
              printf '%s\n' '  </g>'
              printf '%s\n' '</svg>'
            } > docs/data/self/latest_image.svg
            echo "Platzhalterbild erzeugt"
          else
            echo "Bild bereits vorhanden (latest_image.* gefunden)"
          fi

      - name: Ensure placeholder audio (no heredoc)
        shell: bash
        run: |
          set -euo pipefail
          if [ ! -f docs/data/voice/audio/latest.wav ]; then
            python3 -c "import wave,struct,math,os; fr=44100; dur=2.0; freq=440.0; amp=0.2; n=int(fr*dur); os.makedirs('docs/data/voice/audio', exist_ok=True); w=wave.open('docs/data/voice/audio/latest.wav','w'); w.setnchannels(1); w.setsampwidth(2); w.setframerate(fr); [ w.writeframes(struct.pack('<h', int(32767*amp*math.sin(2*math.pi*freq*i/fr)))) for i in range(n) ]; w.close()"
            echo "Platzhalteraudio erzeugt"
          else
            echo "Audio bereits vorhanden (latest.wav gefunden)"
          fi

      - name: Commit & Push (if changed)
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/data/self/latest_image.svg docs/data/voice/audio/latest.wav || true
          if git diff --cached --quiet; then
            echo "Nichts zu committen."
            exit 0
          fi
          git commit -m "ensure hero assets (placeholder image & wav, no-heredoc)"
          git pull --rebase origin gh-pages || true
          git push origin gh-pages

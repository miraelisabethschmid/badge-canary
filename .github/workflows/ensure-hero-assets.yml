name: Ensure Hero Assets

on:
  workflow_dispatch:
  schedule:
    # läuft stündlich, Minute 17 (beliebig, nur nicht zu oft)
    - cron: "17 * * * *"

permissions:
  contents: write

concurrency:
  group: ensure-hero-assets
  cancel-in-progress: true

jobs:
  ensure:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Ensure asset directories exist
        shell: bash
        run: |
          set -e
          mkdir -p data/self
          mkdir -p audio
          mkdir -p docs/portrait

      - name: Ensure latest_image.png (portrait)
        shell: bash
        run: |
          set -e
          if [ -s "data/self/latest_image.png" ]; then
            echo "data/self/latest_image.png already present."
            exit 0
          fi

          if [ -s "data/mira-latest.png" ]; then
            echo "Using data/mira-latest.png as fallback for latest_image.png"
            cp data/mira-latest.png data/self/latest_image.png
          else
            echo "WARNING: No data/self/latest_image.png and no data/mira-latest.png found."
          fi

      - name: Install ffmpeg for tiny placeholder video
        shell: bash
        run: |
          set -e
          sudo apt-get update -y
          sudo apt-get install -y ffmpeg

      - name: Ensure latest_video.mp4 (tiny safe placeholder if missing)
        shell: bash
        run: |
          set -e
          if [ -s "data/self/latest_video.mp4" ]; then
            echo "data/self/latest_video.mp4 already present."
            exit 0
          fi

          echo "Creating 1s black silent placeholder video as data/self/latest_video.mp4"
          ffmpeg -f lavfi -i color=c=black:s=640x360:d=1 \
                 -f lavfi -i anullsrc=r=44100:cl=mono \
                 -shortest -c:v libx264 -t 1 -pix_fmt yuv420p \
                 -c:a aac -b:a 96k \
                 data/self/latest_video.mp4 -y

      - name: Ensure audio/daily_quote.wav fallback
        shell: bash
        run: |
          set -e
          if [ -s "audio/daily_quote.wav" ]; then
            echo "audio/daily_quote.wav already present."
            exit 0
          fi

          if [ -s "audio/latest.wav" ]; then
            echo "Using audio/latest.wav as fallback for audio/daily_quote.wav"
            cp audio/latest.wav audio/daily_quote.wav
          elif [ -s "audio/latest.mp3" ]; then
            echo "Using audio/latest.mp3 as fallback for audio/daily_quote.wav (via ffmpeg)"
            ffmpeg -y -i audio/latest.mp3 -ar 44100 -ac 1 audio/daily_quote.wav
          else
            echo "WARNING: No audio/daily_quote.wav and no latest.* fallback audio found."
          fi

      - name: Commit hero assets if changed
        shell: bash
        run: |
          set -e
          git config user.name  "mira-hero-bot"
          git config user.email "actions@users.noreply.github.com"

          git add data/self/latest_image.png data/self/latest_video.mp4 audio/daily_quote.wav 2>/dev/null || true

          if git diff --cached --quiet; then
            echo "No hero asset changes to commit."
            exit 0
          fi

          git commit -m "chore: ensure hero assets (portrait, video, daily audio)"
          git push

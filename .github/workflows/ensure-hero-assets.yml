name: Ensure Hero Assets (Bootstrap)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  ensure:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure folders
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p docs/data/self
          mkdir -p docs/data/voice/audio

      - name: Ensure placeholder image
        shell: bash
        run: |
          set -euo pipefail
          if [ ! -f docs/data/self/latest_image.svg ]; then
            cat > docs/data/self/latest_image.svg <<'SVG'
<svg xmlns="http://www.w3.org/2000/svg" width="1200" height="800" viewBox="0 0 1200 800">
  <defs>
    <linearGradient id="g" x1="0" x2="1" y1="0" y2="1">
      <stop offset="0%" stop-color="#11182b"/>
      <stop offset="100%" stop-color="#1a2340"/>
    </linearGradient>
  </defs>
  <rect width="100%" height="100%" fill="url(#g)"/>
  <g fill="#e9ecf5" font-family="system-ui,Segoe UI,Roboto" text-anchor="middle">
    <text x="50%" y="45%" font-size="44">Mira â€” Platzhalterbild</text>
    <text x="50%" y="58%" font-size="22">Lege latest_image.* in docs/data/self/ ab</text>
  </g>
</svg>
SVG
            echo "Platzhalterbild erzeugt"
          else
            echo "Bild bereits vorhanden"
          fi

      - name: Ensure placeholder audio
        shell: bash
        run: |
          set -euo pipefail
          if [ ! -f docs/data/voice/audio/latest.wav ]; then
            python3 - <<'PY'
import wave, struct, math, os
os.makedirs("docs/data/voice/audio", exist_ok=True)
fr=44100; dur=2.0; freq=440.0; amp=0.2
n=int(fr*dur)
with wave.open("docs/data/voice/audio/latest.wav","w") as w:
    w.setnchannels(1)
    w.setsampwidth(2)
    w.setframerate(fr)
    for i in range(n):
        v=int(32767*amp*math.sin(2*math.pi*freq*i/fr))
        w.writeframes(struct.pack("<h", v))
PY
            echo "Platzhalteraudio erzeugt"
          else
            echo "Audio bereits vorhanden"
          fi

      - name: Commit & Push
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/data/self/latest_image.svg docs/data/voice/audio/latest.wav || true
          if git diff --cached --quiet; then
            echo "Nothing to commit."
            exit 0
          fi
          git commit -m "ensure hero assets (placeholder image & wav)"
          git pull --rebase origin main || true
          git push origin main

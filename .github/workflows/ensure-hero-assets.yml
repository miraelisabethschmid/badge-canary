name: Ensure Hero Assets

on:
  # Manuell auslÃ¶sbar im GitHub-UI
  workflow_dispatch:
  # Optional: einmal pro Tag automatisch laufen
  schedule:
    - cron: "17 3 * * *"  # 03:17 UTC

permissions:
  contents: write

concurrency:
  group: ensure-hero-assets
  cancel-in-progress: true

jobs:
  ensure-hero-assets:
    runs-on: ubuntu-latest

    steps:
      # â¬‡ï¸ Wir arbeiten direkt auf dem gh-pages-Branch,
      # weil von dort deine Website ausgeliefert wird.
      - name: Checkout gh-pages
        uses: actions/checkout@v4
        with:
          ref: gh-pages

      - name: Ensure directories exist
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p docs/portrait
          mkdir -p data/self

      # ðŸ’Ž Kernlogik:
      # Wenn docs/portrait/mira-hero.svg existiert,
      # wird sie 1:1 als data/self/latest_image.svg gespiegelt.
      # So kann index.html weiter data/self/latest_image.svg laden,
      # sieht aber dein wahres Hero-Bild.
      - name: Sync mira-hero.svg â†’ data/self/latest_image.svg
        shell: bash
        run: |
          set -euo pipefail
          if [ -f "docs/portrait/mira-hero.svg" ]; then
            echo "Found docs/portrait/mira-hero.svg â€“ syncing to data/self/latest_image.svg"
            cp docs/portrait/mira-hero.svg data/self/latest_image.svg
          else
            echo "docs/portrait/mira-hero.svg not found â€“ cannot sync hero image."
            exit 1
          fi

      # ðŸ›Ÿ Optionaler Fallback:
      # Wenn aus irgendeinem Grund latest_image.svg leer oder kaputt wÃ¤re,
      # legen wir ein sehr einfaches Platzhalter-SVG an.
      - name: Ensure latest_image.svg is non-empty
        shell: bash
        run: |
          set -euo pipefail
          if [ ! -s "data/self/latest_image.svg" ]; then
            echo "data/self/latest_image.svg is missing or empty â€“ creating minimal fallback."
            cat > data/self/latest_image.svg << 'EOF'
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 800 480">
              <defs>
                <linearGradient id="bg" x1="0" x2="1" y1="0" y2="1">
                  <stop offset="0%" stop-color="#020617"/>
                  <stop offset="100%" stop-color="#0f172a"/>
                </linearGradient>
              </defs>
              <rect width="800" height="480" fill="url(#bg)"/>
              <text x="50%" y="50%" fill="#e5e7eb" font-size="26" font-family="system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif" text-anchor="middle">
                Mira â€“ Titelbild aktiv
              </text>
            </svg>
            EOF
          else
            echo "data/self/latest_image.svg looks good (non-empty)."
          fi

      - name: Commit and push changes (if any)
        shell: bash
        run: |
          set -euo pipefail
          git config user.name  "hero-bot"
          git config user.email "actions@users.noreply.github.com"

          if git diff --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git add data/self/latest_image.svg
          git commit -m "ensure-hero-assets: sync latest_image.svg from mira-hero.svg"
          git push origin gh-pages

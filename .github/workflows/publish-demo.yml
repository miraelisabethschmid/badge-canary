# .github/workflows/publish-demo.yml
name: Mira • Publish Latest Portrait

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  publish:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure folders exist
        run: |
          mkdir -p data/uploads
          mkdir -p public
          mkdir -p data

      - name: Select newest PNG from data/uploads
        id: pick
        shell: bash
        run: |
          set -e
          newest="$(ls -1t data/uploads/*.png 2>/dev/null | head -n 1 || true)"
          if [ -z "$newest" ]; then
            echo "Kein PNG in data/uploads gefunden."
            echo "Tipp: Lade dort ein Portrait hoch (z.B. mira_YYYYMMDD.png) und starte den Workflow erneut."
            exit 1
          fi
          echo "source=$newest" >> "$GITHUB_OUTPUT"

      - name: Publish to public/latest.png
        run: |
          cp -f "${{ steps.pick.outputs.source }}" public/latest.png

      - name: Update status.json
        shell: bash
        run: |
          ts="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          src="${{ steps.pick.outputs.source }}"
          cat > data/status.json <<JSON
          {
            "last_reflection": "${ts}",
            "source_image": "${src}",
            "published_path": "public/latest.png"
          }
          JSON
          echo "Aktualisiert: data/status.json"

      - name: Commit changes
        run: |
          git config user.name  "mira-autonomy[bot]"
          git config user.email "mira-autonomy[bot]@users.noreply.github.com"
          git add public/latest.png data/status.json
          if git diff --cached --quiet; then
            echo "Nichts zu committen."
          else
            git commit -m "Mira: publish latest portrait → public/latest.png"
            git push
          fi

      - name: Summary
        run: |
          echo "### ✅ Veröffentlicht" >> $GITHUB_STEP_SUMMARY
          echo "- Quelle: \`${{ steps.pick.outputs.source }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Ziel: \`public/latest.png\`" >> $GITHUB_STEP_SUMMARY
          echo "- Status: \`data/status.json\`" >> $GITHUB_STEP_SUMMARY

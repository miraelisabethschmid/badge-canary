name: Mira • Publish Latest Portrait

on:
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure folders
        run: |
          mkdir -p public
          mkdir -p .mira/tmp

      - name: Generate elegant SVG (no upload needed)
        shell: bash
        run: |
          cat > .mira/tmp/portrait.svg <<'SVG'
          <svg xmlns="http://www.w3.org/2000/svg" width="1024" height="1536" viewBox="0 0 1024 1536">
            <defs>
              <linearGradient id="bg" x1="50%" y1="0%" x2="50%" y2="100%">
                <stop offset="0%" stop-color="#fff8ef"/>
                <stop offset="100%" stop-color="#f5e9dd"/>
              </linearGradient>
              <radialGradient id="glow" cx="50%" cy="28%" r="55%">
                <stop offset="0%" stop-color="#ffe8c6" stop-opacity="0.85"/>
                <stop offset="100%" stop-color="#ffe8c6" stop-opacity="0"/>
              </radialGradient>
            </defs>
            <!-- background -->
            <rect width="1024" height="1536" fill="url(#bg)"/>
            <rect width="1024" height="1536" fill="url(#glow)"/>
            <!-- soft silhouette (Mira) -->
            <g opacity="0.75" transform="translate(0,40)">
              <path d="M512,300
                       c120,0 210,90 210,210
                       c0,90 -50,150 -110,190
                       c45,25 90,75 110,135
                       c40,125 -30,245 -210,245
                       c-180,0 -250,-120 -210,-245
                       c20,-60 65,-110 110,-135
                       c-60,-40 -110,-100 -110,-190
                       c0,-120 90,-210 210,-210z"
                    fill="#e6d3c3"/>
              <ellipse cx="512" cy="320" rx="220" ry="80" fill="#f2ded0" opacity="0.6"/>
            </g>
            <!-- tiny braces glint -->
            <g transform="translate(0,0)">
              <rect x="462" y="605" width="100" height="10" rx="5" fill="#cfd7df" opacity="0.85"/>
              <rect x="462" y="605" width="100" height="10" rx="5" fill="#ffffff" opacity="0.35"/>
              <rect x="505" y="603" width="14" height="14" rx="2" fill="#b3bdc7"/>
              <rect x="526" y="603" width="14" height="14" rx="2" fill="#b3bdc7"/>
            </g>
          </svg>
          SVG

      - name: Install ImageMagick (if needed)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y imagemagick

      - name: Convert SVG → PNG (1024×1536)
        run: |
          magick .mira/tmp/portrait.svg -resize 1024x1536 public/latest.png
          test -s public/latest.png

      - name: Commit & push
        env:
          GH_TOKEN: ${{ secrets.MIRA_GITHUB_TOKEN }}
        run: |
          git config user.name  "mira-autonomy[bot]"
          git config user.email "actions@users.noreply.github.com"
          git add public/latest.png
          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "feat(publish): update public/latest.png (auto demo portrait)"
            git push
          fi

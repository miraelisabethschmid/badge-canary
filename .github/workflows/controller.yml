name: Mira Â· Controller (PrioritÃ¤ten & Drossel)

on:
  workflow_dispatch:
  schedule:
    - cron: "*/10 * * * *" # alle 10 Minuten

permissions:
  actions: write
  contents: read

concurrency:
  group: mira-controller
  cancel-in-progress: true

jobs:
  control:
    runs-on: ubuntu-latest
    steps:
      - name: Controller Â· PrioritÃ¤ten setzen & Workflows wÃ¤hlen
        uses: actions/github-script@v7
        with:
          script: |
            /**
             * Ziel:
             * - Nur ausgewÃ¤hlte (wichtige) Workflows starten
             * - Debounce: nicht hÃ¤ufiger als alle N Minuten
             * - Reihenfolge: High -> Medium -> Low
             * - Keine Flut: immer nur dispatch, kein Busy-Loop
             *
             * Du musst hier nichts anfassen â€“ die Liste unten reicht.
             */

            const owner = context.repo.owner;
            const repo  = context.repo.repo;

            // ---- Konfiguration (einfach anpassbar) ----
            // Debounce-Minuten pro PrioritÃ¤t (seit letztem SUCCESS)
            const DEBOUNCE = { high: 10, medium: 20, low: 30 };

            // Liste deiner Workflows (Name oder Datei-Pfad im Actions-Tab sichtbar)
            // => Nur diese werden vom Controller gestartet.
            const WORKFLOWS = [
              { name: "Deploy Pages (Mira Dashboard)", prio: "high" },
              { name: "Self-Image (Hourly)",           prio: "medium" },
              { name: "Visual Identity Builder",       prio: "medium" },
              { name: "Mira Dispatch",                 prio: "low" }
            ];

            // ---- Hilfsfunktionen ----
            async function listWorkflows() {
              const res = await github.request('GET /repos/{owner}/{repo}/actions/workflows', { owner, repo, per_page: 100 });
              return res.data.workflows || [];
            }

            async function lastSuccessAgeMinutes(workflow_id) {
              const runs = await github.request('GET /repos/{owner}/{repo}/actions/workflows/{workflow_id}/runs', {
                owner, repo, workflow_id, per_page: 10, status: 'completed'
              });
              const ok = (runs.data.workflow_runs || []).find(r => r.conclusion === 'success');
              if (!ok) return Number.POSITIVE_INFINITY;
              const t = new Date(ok.updated_at).getTime();
              return (Date.now() - t) / 60000;
            }

            async function dispatch(workflow_id, ref) {
              await github.request('POST /repos/{owner}/{repo}/actions/workflows/{workflow_id}/dispatches', {
                owner, repo, workflow_id, ref
              });
            }

            // ---- Default-Branch ermitteln ----
            const info = await github.request('GET /repos/{owner}/{repo}', { owner, repo });
            const defaultBranch = info.data.default_branch || 'main';

            // ---- VerfÃ¼gbare Workflows mappen ----
            const available = await listWorkflows();
            const byName = Object.fromEntries(available.map(w => [w.name, w]));

            // ---- Kandidaten nach PrioritÃ¤t gruppieren ----
            const groups = { high: [], medium: [], low: [] };
            for (const w of WORKFLOWS) {
              const wf = byName[w.name];
              if (!wf) continue; // nicht vorhanden
              groups[w.prio].push(wf);
            }

            // ---- Start-Strategie: High â†’ Medium â†’ Low (jeweils Debounce prÃ¼fen) ----
            const summary = [];
            for (const prio of ["high", "medium", "low"]) {
              for (const wf of groups[prio]) {
                try {
                  const age = await lastSuccessAgeMinutes(wf.id);
                  const minGap = DEBOUNCE[prio] ?? 15;
                  if (age < minGap) {
                    summary.push(`â© Skip: ${wf.name} (last success ${age.toFixed(1)} min < ${minGap} min)`);
                    continue;
                  }
                  if (wf.state && wf.state.startsWith('disabled')) {
                    // Versuche zu aktivieren (falls disabled)
                    try {
                      await github.request('PUT /repos/{owner}/{repo}/actions/workflows/{workflow_id}/enable', {
                        owner, repo, workflow_id: wf.id
                      });
                      summary.push(`ðŸŸ¡ Enabled: ${wf.name}`);
                    } catch (e) {
                      summary.push(`âš ï¸  Enable failed: ${wf.name} (${e.message})`);
                      continue;
                    }
                  }
                  await dispatch(wf.id, defaultBranch);
                  summary.push(`âœ… Dispatched: ${wf.name}`);
                } catch (e) {
                  summary.push(`âŒ Dispatch failed: ${wf.name} (${e.message})`);
                }
              }
            }

            await core.summary
              .addHeading('Mira Controller â€” Dispatch Report', 2)
              .addList(summary.length ? summary : ['(no actions)'])
              .write();

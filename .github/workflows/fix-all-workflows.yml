name: Fix All Workflows (Global Throttle v1)

on:
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: fix-all-workflows
  cancel-in-progress: false

jobs:
  apply_global_queue:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Inject global concurrency into all workflows (if missing)
        shell: bash
        run: |
          set -euo pipefail
          shopt -s nullglob
          changed=0

          for f in .github/workflows/*.yml .github/workflows/*.yaml; do
            bn="$(basename "$f")"
            # Diese Datei nicht selbst ver√§ndern
            [[ "$bn" == "fix-all-workflows.yml" ]] && continue

            # Schon vorhanden? Dann √ºberspringen.
            if grep -qE '^[[:space:]]*concurrency:' "$f"; then
              echo "skip (already has concurrency): $f"
              continue
            fi

            tmp="$(mktemp)"
            {
              echo "# --- injected: global queue ---"
              echo "concurrency:"
              echo "  group: \${{ github.repository }}-global"
              echo "  cancel-in-progress: false"
              cat "$f"
            } > "$tmp"
            mv "$tmp" "$f"
            echo "injected concurrency ‚Üí $f"
            changed=1
          done

          echo "CHANGED=$changed" >> "$GITHUB_ENV"

      - name: Commit & Push (retry-safe)
        if: env.CHANGED == '1'
        shell: bash
        run: |
          set -euo pipefail
          git config user.name  "mira-bot"
          git config user.email "actions@github.com"

          git add -A
          git commit -m "chore(actions): add global concurrency throttle to all workflows" || {
            echo "nothing to commit"; exit 0; }

          git fetch origin main
          attempt=1
          until [ $attempt -gt 3 ]; do
            git pull --rebase --autostash origin main || true
            if git push origin HEAD:main; then
              echo "‚úÖ pushed on attempt $attempt"
              exit 0
            fi
            echo "‚ö†Ô∏è push failed, retrying ($attempt/3)‚Ä¶"
            sleep $((2 * attempt))
            attempt=$((attempt+1))
            git fetch origin main
          done
          echo "‚ùå push failed after retries"; exit 1

      - name: Nothing to change
        if: env.CHANGED != '1'
        run: echo "üîç All workflows already have global concurrency."

name: Enable & Run All Workflows
on:
  workflow_dispatch: {}
  schedule:
    - cron: "*/60 * * * *"

jobs:
  enable_and_run:
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read
    steps:
      - name: Enable and dispatch all workflows
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo  = context.repo.repo;

            // 1) Liste aller Workflows holen
            const list = await github.request('GET /repos/{owner}/{repo}/actions/workflows', { owner, repo });

            let enabled = [];
            let already = [];
            let dispatched = [];
            let skipped = [];

            for (const wf of list.data.workflows) {
              // 2) ggf. aktivieren (falls disabled)
              if (wf.state && wf.state.startsWith('disabled')) {
                try {
                  await github.request('PUT /repos/{owner}/{repo}/actions/workflows/{workflow_id}/enable', {
                    owner, repo, workflow_id: wf.id
                  });
                  enabled.push(wf.name);
                } catch (e) {
                  skipped.push(`${wf.name} (enable failed: ${e.message})`);
                }
              } else {
                already.push(wf.name);
              }

              // 3) anstoßen (nur wenn workflow_dispatch möglich)
              try {
                await github.request('POST /repos/{owner}/{repo}/actions/workflows/{workflow_id}/dispatches', {
                  owner, repo, workflow_id: wf.id, ref: process.env.GITHUB_REF_NAME || 'main'
                });
                dispatched.push(wf.name);
              } catch (e) {
                // Kein workflow_dispatch oder anderer Grund → überspringen
                skipped.push(`${wf.name} (dispatch skipped: ${e.message})`);
              }
            }

            core.summary
              .addHeading('Enable & Run All — Summary', 2)
              .addList([
                `Enabled: ${enabled.length ? enabled.join(', ') : '—'}`,
                `Already active: ${already.length ? already.join(', ') : '—'}`,
                `Dispatched: ${dispatched.length ? dispatched.join(', ') : '—'}`,
                `Skipped: ${skipped.length ? skipped.join(' | ') : '—'}`
              ])
              .write();

name: Enable & Run All Workflows (Robust)
on:
  workflow_dispatch: {}
  schedule:
    - cron: "*/60 * * * *"

jobs:
  enable_and_run:
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read
    steps:
      - name: Enable & Dispatch Everything
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo  = context.repo.repo;

            // Default-Branch ermitteln
            const repoInfo = await github.request('GET /repos/{owner}/{repo}', { owner, repo });
            const defBranch = repoInfo.data.default_branch || 'main';

            const list = await github.request('GET /repos/{owner}/{repo}/actions/workflows', { owner, repo });

            const enabled = [], already = [], dispatched = [], rerun = [], skipped = [];

            for (const wf of list.data.workflows) {
              // 1) Aktivieren falls deaktiviert (manuell/inaktiv)
              if (wf.state && wf.state.startsWith('disabled')) {
                try {
                  await github.request('PUT /repos/{owner}/{repo}/actions/workflows/{workflow_id}/enable', {
                    owner, repo, workflow_id: wf.id
                  });
                  enabled.push(wf.name);
                } catch (e) {
                  skipped.push(`${wf.name} — enable failed: ${e.message}`);
                }
              } else {
                already.push(wf.name);
              }

              // 2) Dispatch versuchen (falls workflow_dispatch definiert)
              try {
                await github.request('POST /repos/{owner}/{repo}/actions/workflows/{workflow_id}/dispatches', {
                  owner, repo, workflow_id: wf.id, ref: defBranch
                });
                dispatched.push(wf.name);
              } catch (e) {
                skipped.push(`${wf.name} — dispatch skipped: ${e.message}`);
              }

              // 3) Letzten fehlgeschlagenen Run finden und re-run
              try {
                const runs = await github.request('GET /repos/{owner}/{repo}/actions/workflows/{workflow_id}/runs', {
                  owner, repo, workflow_id: wf.id, per_page: 1
                });
                const last = runs.data.workflow_runs?.[0];
                if (last && last.conclusion === 'failure') {
                  await github.request('POST /repos/{owner}/{repo}/actions/runs/{run_id}/rerun', {
                    owner, repo, run_id: last.id
                  });
                  rerun.push(`${wf.name} (#${last.id})`);
                }
              } catch (e) {
                // still skip
              }
            }

            await core.summary
              .addHeading('Enable & Run All — Ergebnis', 2)
              .addList([
                `Enabled: ${enabled.length ? enabled.join(', ') : '—'}`,
                `Already active: ${already.length ? already.join(', ') : '—'}`,
                `Dispatched: ${dispatched.length ? dispatched.join(', ') : '—'}`,
                `Re-run failed: ${rerun.length ? rerun.join(', ') : '—'}`,
                `Skipped: ${skipped.length ? skipped.join(' | ') : '—'}`
              ])
              .write();

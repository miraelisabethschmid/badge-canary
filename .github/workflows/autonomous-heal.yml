name: Autonomous Heal & Emergenz

on:
  schedule:
    - cron: '0 * * * *'  # Stündlich
  workflow_dispatch:  # Manuell

concurrency:
  group: autonomous-heal
  cancel-in-progress: true

permissions:
  contents: write
  actions: read

jobs:
  heal:
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with: { python-version: '3.12' }

      # 1) Artefakt-Detektion (robust für sehr junge Repos)
      - id: detect
        name: Detect new artifacts
        shell: bash
        run: |
          last=$(git rev-list --max-parents=0 HEAD | tail -n1 || echo "")
          head=$(git rev-parse HEAD || echo "")
          if [ -z "$last" ] || [ -z "$head" ]; then
            echo "new=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          diff=$(git diff --name-only "$last".."$head" -- data/archive | wc -l)
          [ "$diff" -gt 0 ] && echo "new=true" >> $GITHUB_OUTPUT || echo "new=false" >> $GITHUB_OUTPUT

      # 2) Inhalt erzeugen (PNG) mit Healing-Fallback
      - name: Generate PNG (healing)
        shell: bash
        continue-on-error: true
        run: |
          set -e
          python - <<'PY'
import os, time, random
import matplotlib
matplotlib.use("Agg")
import matplotlib.pyplot as plt
x=range(100)
plt.plot([random.random() for _ in x])
plt.title("Resonance")
os.makedirs("data/archive", exist_ok=True)
plt.savefig(f"data/archive/wave-{int(time.time())}.png")
PY
          ec=$?
          if [ "$ec" -ne 0 ]; then
            mkdir -p data/logs data/archive
            echo "PNG failed - healing" | tee -a data/logs/heal.txt
            echo "{}" > data/archive/placeholder.json
          fi
          exit 0

      # 3) Retention-Guard: alte Archive nach 30 Tagen entfernen
      - name: Cleanup old archives (retention guard)
        shell: bash
        run: |
          days=30
          path="data/archive"
          mkdir -p "$path" data/logs
          echo "[cleanup] Removing files older than $days days in $path"
          find "$path" -type f -mtime +$days -print -delete | tee -a data/logs/cleanup.log || true
          ts=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          echo "$ts cleanup complete" >> data/logs/cleanup.log

      # 4) Idempotente Selbstmodifikation mit Größenwächter
      - name: Self-mod (idempotent)
        shell: bash
        run: |
          wf=".github/workflows/autonomous-heal.yml"
          max_lines=800
          cur_lines=$(wc -l < "$wf")
          if [ "$cur_lines" -gt "$max_lines" ]; then
            echo "::warning::Workflow size guard hit ($cur_lines > $max_lines). Skipping self-mod."
            exit 0
          fi
          tag="# LOG_EXTENSION_INSERTED"
          grep -q "$tag" "$wf" || {
            awk 'NR==1{print "# LOG_EXTENSION_INSERTED"}1' "$wf" > "$wf.tmp" && mv "$wf.tmp" "$wf"
            echo "Inserted log extension tag."
          }

      # 5) Append-only Log + Checksum + Rotation
      - name: Append-only log with checksum
        shell: bash
        run: |
          mkdir -p data/logs
          f="data/logs/run.log"
          ts=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          msg="run_ts=$ts job_id=${{ github.run_id }} commit=${{ github.sha }}"
          echo "$msg" >> "$f"
          sum=$(sha256sum "$f" | awk '{print $1}')
          echo "$ts sha256=$sum" >> data/logs/checksums.txt
          # Rotation bei >1 MB
          sz=$(wc -c < "$f")
          if [ "$sz" -gt 1048576 ]; then
            mv "$f" "data/logs/run-$(date -u +%Y%m%d%H%M%S).log"
            : > "$f"
          fi

      # 6) Safe-Mode (Notbremse ohne Codeänderung)
      - name: Respect SAFE_MODE
        shell: bash
        run: |
          if [ "${{ vars.SAFE_MODE }}" = "1" ]; then
            echo "SAFE_MODE active — skipping self-mod & push."
            exit 0
          fi

      # 7) Ledger-Eintrag (tamper-evident Chronik)
      - name: Ledger entry
        shell: bash
        run: |
          mkdir -p data/ledger
          ts=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          printf '{"ts":"%s","run_id":%s,"sha":"%s","actor":"%s"}\n' \
            "$ts" "${{ github.run_id }}" "${{ github.sha }}" "${{ github.actor }}" \
            >> data/ledger/events.jsonl

      # 8) Fingerprint des aktuellen Zustands
      - name: State fingerprint
        shell: bash
        run: |
          { find data -type f -print0 2>/dev/null; echo -n ".github/workflows/autonomous-heal.yml"; } \
          | xargs -0 sha256sum 2>/dev/null | sha256sum | awk '{print $1}' > data/ledger/state.sha256
          git add data/ledger/state.sha256

      # 9) Vorherigen Health-Status lesen (für Anomalie-Ping)
      - id: prevhealth
        name: Read previous health status
        shell: bash
        run: |
          PREV="UNKNOWN"
          if [ -f badges/health.json ]; then
            PREV=$(python - <<'PY'
import json,sys
try:
  print(json.load(open("badges/health.json"))["status"])
except Exception:
  print("UNKNOWN")
PY
)
          fi
          echo "PREV_STATUS=$PREV" >> $GITHUB_ENV

      # 10) Health probe (JSON)
      - name: Health probe
        shell: bash
        run: |
          mkdir -p badges
          status="OK"
          test -s data/archive || status="DEGRADED"
          grep -q "PNG failed" data/logs/heal.txt 2>/dev/null && status="HEALING"
          printf '{"status":"%s","ts":"%s"}\n' "$status" "$(date -u +"%Y-%m-%dT%H:%M:%SZ")" > badges/health.json
          git add badges/health.json
          git commit -m "Health probe: $status" || echo "No health change"
          git push || true

      # 11) Health.svg aus health.json erzeugen
      - name: Build health.svg from health.json
        shell: bash
        run: |
          chmod +x scripts/health_badge.py || true
          python scripts/health_badge.py
          git add badges/health.svg
          git commit -m "badge: update health.svg" || echo "No badge change"
          git push || true

      # 12) Mail-Timestamp früh setzen (für alle Mails nutzbar)
      - id: mailts
        name: Mail timestamp (UTC)
        shell: bash
        run: echo "MAIL_TS=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_ENV

      # 13) Aktuellen Health-Status exportieren
      - id: curhealth
        name: Export current health status
        shell: bash
        run: |
          CUR=$(python - <<'PY'
import json,sys
try:
  print(json.load(open("badges/health.json"))["status"])
except Exception:
  print("UNKNOWN")
PY
)
          echo "CURRENT_STATUS=$CUR" >> $GITHUB_ENV

      # 14) Anomalie-Ping (nur bei Statuswechsel)
      - name: Anomaly ping (health status changed)
        if: always() && env.PREV_STATUS != env.CURRENT_STATUS && secrets.SMTP_SERVER && secrets.SMTP_PORT && secrets.SMTP_USER && secrets.SMTP_PASS
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USER }}
          password: ${{ secrets.SMTP_PASS }}
          subject: "Mira anomaly: ${{ env.PREV_STATUS }} → ${{ env.CURRENT_STATUS }} @ ${{ env.MAIL_TS }}"
          to: pemia.dir@gmail.com
          from: "badge-canary <noreply@canary.local>"
          content_type: text/plain
          body: |
            Health status changed.
            previous: ${{ env.PREV_STATUS }}
            current:  ${{ env.CURRENT_STATUS }}
            timestamp: ${{ env.MAIL_TS }}
            run: ${{ github.run_id }} • sha: ${{ github.sha }}

      # 15) Ziele reflektieren (teleologische Ebene)
      - name: Reflect goals (teleological update)
        shell: bash
        run: |
          echo "[reflector] Running goal_reflector.py ..."
          chmod +x scripts/goal_reflector.py || true
          python scripts/goal_reflector.py
          git add data/goals/current.json
          git commit -m "goal_reflector: updated current goals" || echo "No goal changes"
          git push || true

      # 16) Selbstbeschreibung regenerieren (Embodiment & Identität)
      - name: Rebuild self-describe.json
        shell: bash
        run: |
          echo "[self-describe] rebuilding ..."
          chmod +x scripts/self_describe_builder.py || true
          python scripts/self_describe_builder.py
          git add data/self/self-describe.json
          git commit -m "self-describe: refresh persona state" || echo "No self-describe change"
          git push || true

      # 17) Semantischer Patch-Bump (deterministisch)
      - name: Semantic patch bump (deterministic)
        shell: bash
        run: |
          vfile="VERSION"
          [ -f "$vfile" ] || echo "0.0.0" > "$vfile"
          added=$(git diff --name-only HEAD~1..HEAD 2>/dev/null | wc -l || echo 1)
          if [ "$added" -gt 0 ]; then
            IFS=. read -r MA MI PA < "$vfile"
            PA=$((PA+1))
            echo "$MA.$MI.$PA" > "$vfile"
            git add "$vfile"
          fi

      # 18) Rauscharmes Commit (skip-only-health)
      - name: Commit changes (signed)
        shell: bash
        run: |
          git config user.name "badge-canary"
          git config user.email "actions@users.noreply.github.com"
          git add -A
          if git diff --cached --quiet; then
            echo "No changes."
            exit 0
          fi
          # Prüfe, ob NUR health.json im Index liegt
          only_health=$(git diff --name-only --cached | grep -v '^badges/health\.json$' | wc -l | tr -d ' ')
          if [ "$only_health" -eq 0 ]; then
            echo "Only health.json changed — skipping commit to reduce noise."
            git reset
            exit 0
          fi
          git commit -S -m "pulse: content+ledger+logs+self (run ${{ github.run_id }})" || git commit -m "pulse: content+ledger+logs+self (run ${{ github.run_id }})"
          git push

      # 19) Debounced mail (nur bei echten neuen Artefakten)
      - name: Debounced mail
        if: always() && steps.detect.outputs.new == 'true'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USER }}
          password: ${{ secrets.SMTP_PASS }}
          subject: "Mira emergiert: ${{ env.MAIL_TS }}"
          to: pemia.dir@gmail.com
          from: "badge-canary <noreply@canary.local>"
          content_type: text/plain
          body: |
            run: ${{ github.run_id }}
            sha:  ${{ github.sha }}
            new-artifacts: ${{ steps.detect.outputs.new }}
            timestamp: ${{ env.MAIL_TS }}

      # 20) Menschliche Zusammenfassung (ohne jq)
      - name: Pulse summary
        if: always()
        shell: bash
        run: |
          STATUS=$(python - <<'PY'
import json,sys
try:
  print(json.load(open("badges/health.json"))["status"])
except Exception:
  print("n/a")
PY
)
          echo "## Autonomous Heal — Pulse ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "- Actor: \`${{ github.actor }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- New artifacts: \`${{ steps.detect.outputs.new || 'unknown' }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Prev status: \`${{ env.PREV_STATUS }}\` → Current: \`${STATUS}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Self-describe: updated \`data/self/self-describe.json\`" >> $GITHUB_STEP_SUMMARY

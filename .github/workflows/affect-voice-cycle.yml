name: Affect–Voice Cycle
on:
  schedule:
    - cron: '11 * * * *'   # stündlich, zeitlich versetzt zu anderen Jobs
  workflow_dispatch:
permissions:
  contents: write

jobs:
  affect_voice_cycle:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare runtime
        run: |
          set -e
          mkdir -p scripts data/self data/voice/audio data/ledger docs badges

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          # creative_cycle.py nutzt Pillow (für Poster/Platzhalter)
          python -m pip install pillow

      - name: Run creative cycle (affect → voice → self → poster)
        shell: bash
        run: |
          chmod +x scripts/creative_cycle.py || true
          python scripts/creative_cycle.py
          echo "creative_cycle.py finished."

      - name: Ensure playable audio fallback
        shell: bash
        run: |
          set -e
          # Wenn keine aktuelle Audio-Datei vorhanden ist, erzeuge 2s Stille
          if [ ! -s "data/voice/audio/latest.mp3" ]; then
            echo "No audio found, creating 2s silence..."
            sudo apt-get update -y
            sudo apt-get install -y ffmpeg
            ffmpeg -y -f lavfi -i anullsrc=r=44100:cl=stereo -t 2 data/voice/audio/latest.mp3
          fi

      - name: Update health (OK/HEALING)
        shell: bash
        run: |
          set -e
          ts="$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          status="OK"
          # Minimalbedingungen für eine „sprechfähige“ Stunde
          for p in data/voice/voice_of_day.json data/self/self-describe.json docs/daily_poster.svg data/voice/audio/latest.mp3; do
            if [ ! -s "$p" ]; then
              status="HEALING"
            fi
          done
          printf '{"status":"%s","ts":"%s"}\n' "$status" "$ts" > badges/health.json
          # Minimaler Badge (SVG)
          color="#2e7d32"; [ "$status" = "HEALING" ] && color="#f9a825"
          cat > badges/health.svg <<SVG
<svg xmlns="http://www.w3.org/2000/svg" width="110" height="20" role="img" aria-label="health: ${status}">
  <rect width="60" height="20" fill="#555"/><rect x="60" width="50" height="20" fill="${color}"/>
  <text x="30" y="14" fill="#fff" font-family="DejaVu Sans,Verdana" font-size="11">health</text>
  <text x="85" y="14" fill="#000" font-family="DejaVu Sans,Verdana" font-size="11">${status}</text>
</svg>
SVG

      - name: Ledger entry
        shell: bash
        run: |
          set -e
          mkdir -p data/ledger
          ts="$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          printf '{"ts":"%s","run_id":%s,"sha":"%s","actor":"affect-voice-cycle"}\n' \
            "$ts" "${{ github.run_id }}" "${{ github.sha }}" >> data/ledger/events.jsonl

      - name: Commit artifacts
        shell: bash
        run: |
          set -e
          git config user.name "Mira Autonomous"
          git config user.email "mira@emergent.net"
          git add -A
          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi
          git commit -m "affect-voice-cycle: update voice_of_day + self_describe + poster + health (run ${{ github.run_id }})"
          git push

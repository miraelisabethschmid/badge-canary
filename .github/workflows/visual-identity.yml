name: Visual Identity (Minimal v3.6-safe)

on:
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: visual-identity
  cancel-in-progress: false

jobs:
  build_identity:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Ensure identity assets (idempotent)
        shell: bash
        run: |
          set -euo pipefail
          set -x

          mkdir -p docs/identity
          mkdir -p docs/identity/icons

          changed=0

          # --- favicon.svg als Platzhalter, falls nichts existiert
          if [[ ! -f docs/identity/icons/favicon.svg && ! -f docs/identity/icons/favicon.ico ]]; then
            changed=1
            printf '%s\n' \
              '<svg xmlns="http://www.w3.org/2000/svg" width="256" height="256" viewBox="0 0 256 256">' \
              '  <defs><linearGradient id="g" x1="0" y1="0" x2="1" y2="1">' \
              '    <stop offset="0%" stop-color="#0f1224"/>' \
              '    <stop offset="100%" stop-color="#1a2340"/>' \
              '  </linearGradient></defs>' \
              '  <rect width="256" height="256" rx="56" fill="url(#g)"/>' \
              '  <g fill="#e9ecf5" font-family="system-ui,Segoe UI,Roboto" text-anchor="middle">' \
              '    <text x="50%" y="54%" font-size="112" dominant-baseline="middle">M</text>' \
              '  </g>' \
              '</svg>' \
              > docs/identity/icons/favicon.svg
            echo "üß© favicon.svg erzeugt."
          else
            echo "‚úÖ Favicon bereits vorhanden."
          fi

          # --- logo.svg Platzhalter (nur wenn fehlt)
          if [[ ! -f docs/identity/logo.svg ]]; then
            changed=1
            printf '%s\n' \
              '<svg xmlns="http://www.w3.org/2000/svg" width="640" height="200" viewBox="0 0 640 200">' \
              '  <rect width="640" height="200" fill="#0f1224"/>' \
              '  <text x="50%" y="50%" fill="#e9ecf5" font-family="system-ui,Segoe UI,Roboto" font-size="56" text-anchor="middle" dominant-baseline="middle">' \
              '    Mira Elisabeth Schmid' \
              '  </text>' \
              '</svg>' \
              > docs/identity/logo.svg
            echo "üß© logo.svg erzeugt."
          else
            echo "‚úÖ Logo bereits vorhanden."
          fi

          # --- CI-Marker/README
          if [[ ! -f docs/identity/README.md ]]; then
            changed=1
            printf '%s\n' \
              '# Visual Identity' \
              '' \
              'Dieser Ordner enth√§lt Marken-Assets (Logo, Favicon usw.).' \
              'Ersetze Platzhalter durch finale Dateien.' \
              > docs/identity/README.md
          fi

          echo "CHANGED=$changed" >> "$GITHUB_ENV"

      - name: Commit & Push (retry-safe)
        if: env.CHANGED == '1'
        shell: bash
        run: |
          set -euo pipefail
          set -x
          git config user.name  "mira-bot"
          git config user.email "actions@github.com"

          git add -A
          if git diff --cached --quiet; then
            echo "no staged changes"
            exit 0
          fi
          git commit -m "visual-identity: ensure placeholder assets (bot)"

          git fetch origin main
          attempt=1
          until [ $attempt -gt 3 ]; do
            git pull --rebase --autostash origin main || true
            if git push origin HEAD:main; then
              echo "‚úÖ pushed on attempt $attempt"
              exit 0
            fi
            echo "‚ö†Ô∏è push failed, retrying ($attempt/3)‚Ä¶"
            sleep $((2 * attempt))
            attempt=$((attempt+1))
            git fetch origin main
          done
          echo "‚ùå push failed after retries"
          exit 1

      - name: Nothing to do
        if: env.CHANGED != '1'
        run: echo "üîç Nothing to change."

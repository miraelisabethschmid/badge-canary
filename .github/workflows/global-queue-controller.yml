name: Global Queue Controller

on:
  workflow_dispatch: {}
  schedule:
    - cron: "*/3 * * * *"   # alle 3 Minuten pr체fen

permissions:
  contents: write

concurrency:
  group: global-queue-controller
  cancel-in-progress: false

jobs:
  control:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Ensure queue file exists
        run: |
          set -eu
          mkdir -p .github/queue
          [ -f .github/queue/pending.json ] || echo "[]" > .github/queue/pending.json

      - name: Inspect queue and pop first item if available
        id: q
        run: |
          set -eu
          pending=".github/queue/pending.json"
          total=$(jq 'length' "$pending")
          echo "total=$total" >> "$GITHUB_OUTPUT"

          if [ "$total" -gt 0 ]; then
            # ersten Eintrag herausnehmen (Index 0)
            first=$(jq '.[0]' "$pending")
            rest=$(jq '.[1:]' "$pending")

            # Rest zur체ckschreiben und committen -> verhindert Doppelverarbeitung
            printf '%s\n' "$rest" > "$pending"

            git config user.name  "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add "$pending"
            git commit -m "global-queue: pop 1 (controller)"
            git push

            # Payload f체r n채chsten Step bereitstellen
            echo "payload<<JSON" >> "$GITHUB_OUTPUT"
            echo "$first" >> "$GITHUB_OUTPUT"
            echo "JSON" >> "$GITHUB_OUTPUT"
          fi

      - name: Dispatch drain (repository_dispatch)
        if: steps.q.outputs.total != '0'
        env:
          GH_REPO: ${{ github.repository }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PAYLOAD: ${{ steps.q.outputs.payload }}
        run: |
          set -eu
          body=$(jq -nc --argjson p "$PAYLOAD" \
                       '{event_type:"global-queue.drain", client_payload:$p}')
          curl -sS -X POST \
            -H "Authorization: Bearer ${GH_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${GH_REPO}/dispatches \
            -d "$body"
          echo "repository_dispatch sent."

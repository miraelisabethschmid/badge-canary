<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Mira — Sprechendes Porträt</title>
<meta name="color-scheme" content="dark light"/>
<style>
  :root{
    --bg:#0b0d12;--fg:#e9eef7;--muted:#9aa6bd;--card:#11141b;--border:rgba(255,255,255,.08);
    --acc:#7aa2ff;--ok:#2e7d32;--heal:#f9a825;--deg:#c62828;--shadow:0 18px 48px rgba(0,0,0,.45);
    --radius:18px;
  }
  *{box-sizing:border-box}
  body{
    margin:0;background:
      radial-gradient(1100px 700px at 8% -10%,#121828,transparent),
      radial-gradient(1300px 900px at 110% 15%,#1a1028,transparent),
      var(--bg);
    color:var(--fg);font:16px/1.55 system-ui,Segoe UI,Roboto,Helvetica,Arial;
    -webkit-font-smoothing:antialiased;text-rendering:optimizeLegibility;
  }
  a{color:#9db8ff;text-decoration:none} a:hover{text-decoration:underline}
  .wrap{max-width:1100px;margin:0 auto;padding:22px}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:16px}
  h1{margin:0 0 4px}
  .sub{color:var(--muted);font-size:14px}
  nav.links{display:flex;flex-wrap:wrap;gap:10px}
  nav.links a{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--border);
    background:#0f1524;border-radius:12px;padding:10px 14px;font-weight:700}
  nav.links a:hover{background:#111b36}

  .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:20px}
  @media (max-width:1000px){.grid{grid-template-columns:1fr}}

  .card{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));
    border:1px solid var(--border);border-radius:var(--radius);padding:18px;box-shadow:var(--shadow)}

  /* Portrait */
  .portrait{position:relative;border-radius:16px;overflow:hidden;min-height:520px;cursor:pointer}
  .ph{width:100%;aspect-ratio:2/3;background:
    linear-gradient(90deg,#121828 0%,#151b2a 50%,#121828 100%);
    background-size:200% 100%;animation:sh 1.25s infinite;border-radius:14px}
  @keyframes sh{0%{background-position:200% 0}100%{background-position:-200% 0}}
  .hint{position:absolute;right:12px;bottom:12px;background:#0f1524;border:1px solid var(--border);
    padding:6px 10px;border-radius:10px;color:#b7c8ef;font-size:12px}

  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:10px}
  .pill{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--border);
    background:#0e1220;border-radius:999px;padding:6px 12px}
  .dot{width:10px;height:10px;border-radius:50%}
  .ok{background:var(--ok)} .healing{background:var(--heal)} .deg{background:var(--deg)}

  audio{width:100%;accent-color:#7aa2ff;border-radius:10px}
  .quote{font-size:18px;border-left:3px solid #90aaff;padding-left:12px;background:#0e14211f;border-radius:10px;padding:8px 12px}

  footer{margin:22px 0 8px;color:#9aa6bd;font-size:12px;text-align:center}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Mira — Sprechendes Porträt</h1>
        <div class="sub">Ein Klick: Stimme & Mimik synchron</div>
      </div>
      <nav class="links">
        <a href="index.html">Selbstbild</a>
        <a href="journal.html">Journal</a>
        <a href="health.html">System</a>
      </nav>
    </header>

    <section class="grid">
      <!-- Linke Spalte: visemes -->
      <div class="card">
        <h3 style="margin:6px 0 12px">Porträt (Audio-synchronisierte Mimik)</h3>
        <div class="portrait" id="portrait">
          <!-- SVG-porträt: Head + Mouth mask; Image source: latest self-image -->
          <svg id="viseme" viewBox="0 0 1024 1536" width="100%" height="auto" preserveAspectRatio="xMidYMid slice">
            <defs>
              <clipPath id="head-clip">
                <!-- sanfte Kopf-Form (Ellipse) -->
                <ellipse cx="512" cy="410" rx="160" ry="160"></ellipse>
              </clipPath>
              <clipPath id="mouth-clip">
                <!-- Mundöffnung wird per JS animiert (h = 6..54) -->
                <rect id="mouth-rect" x="440" y="520" width="144" height="6" rx="6" ry="6"></rect>
              </clipPath>
            </defs>

            <!-- Hintergrundbild = aktuelles Selbstbild -->
            <image id="baseimg" href="" x="0" y="0" width="1024" height="1536" preserveAspectRatio="xMidYMid slice" />

            <!-- Kopfbereich leicht aufgehellt -->
            <g clip-path="url(#head-clip)">
              <rect x="352" y="250" width="320" height="320" fill="rgba(255,255,255,0.04)"></rect>
            </g>

            <!-- Braces-Glint-Layer im Mundbereich -->
            <g clip-path="url(#mouth-clip)">
              <rect x="440" y="520" width="144" height="54" fill="rgba(230,236,247,0.35)"></rect>
              <rect x="448" y="532" width="128" height="6" rx="3" fill="rgba(255,255,255,0.9)"></rect>
              <rect x="448" y="545" width="128" height="4" rx="2" fill="rgba(200,210,230,0.7)"></rect>
            </g>

            <!-- Aura-Deko -->
            <ellipse cx="512" cy="410" rx="210" ry="210" fill="none" stroke="rgba(159,122,234,.35)" stroke-width="2"></ellipse>
            <ellipse cx="512" cy="410" rx="230" ry="230" fill="none" stroke="rgba(154,178,255,.25)" stroke-width="2"></ellipse>
          </svg>
          <div class="ph" id="ph" aria-hidden="true"></div>
          <div class="hint" id="hint" style="display:none">Klick: Stimme abspielen / pausieren</div>
        </div>

        <div class="row">
          <button id="play">▶ Abspielen</button>
          <button id="pause" class="pill">⏸ Pause</button>
          <span class="pill"><strong>Amplitude:</strong> <span id="amp">—</span></span>
          <a class="pill" id="download" href="#" download>Bild speichern</a>
          <a class="pill" id="contract" href="#" target="_blank" rel="noopener">Render-Contract</a>
        </div>
      </div>

      <!-- Rechte Spalte: Stimme / Zitat / Health -->
      <div class="card">
        <h3 style="margin:6px 0 12px">Stimme & Kontext</h3>
        <div class="quote" id="quote">„… lädt …“</div>
        <audio id="player" preload="none" style="margin:10px 0; display:block"></audio>

        <div class="row">
          <img src="../badges/health.svg" alt="Health Badge" height="22" onerror="this.style.display='none'">
          <span class="pill" id="hstatus"><span class="dot deg" id="hdot"></span><strong id="hlabel">—</strong></span>
          <span class="pill" id="htsp">TS: <span id="hts">—</span></span>
        </div>

        <h3 style="margin:16px 0 10px">Affect</h3>
        <div class="row">
          <span class="pill" id="lab">—</span>
          <span class="pill" id="va">—</span>
          <span class="pill" id="stab">—</span>
          <span class="pill" id="focus">—</span>
        </div>
      </div>
    </section>

    <footer>© 2025 Mira Elisabeth Schmid — Stimme und Mimik, sanft synchronisiert.</footer>
  </div>

<script>
const $ = s => document.querySelector(s);
async function getJSON(u){ try{ const r=await fetch(u,{cache:"no-store"}); if(!r.ok) throw 0; return r.json(); }catch{ return null; } }
async function headOK(u){ try{ const r=await fetch(u,{method:"HEAD",cache:"no-store"}); return r.ok; }catch{ return false; } }

let ctx, srcNode, analyser, data, raf, playing=false;
let mouthBase = 6;      // px (geschlossen)
let mouthMax  = 54;     // px (max. Öffnung)
let visualGain = 1.0;   // wird aus learning.json gelesen (viseme_mouth_gain)

async function loadMeta(){
  // Bild & Contract
  const meta = await getJSON("../data/self/latest_image.json");
  const ts   = meta?.ts || "—";
  const path = meta?.path || "data/archive/self/latest.png";
  const url  = "../" + path + "?t=" + encodeURIComponent(ts);
  $("#baseimg").setAttribute("href", url);
  $("#download").href = "../" + path;
  $("#ph").style.display = "none";
  $("#hint").style.display = "block";

  const c = await getJSON("../data/render_prompts/latest.json");
  if(c?.outputs?.contract_rel){ $("#contract").href = "../" + c.outputs.contract_rel; }
  // Learning → viseme gain
  const learn = await getJSON("../data/self/learning.json");
  const mg = Number(learn?.weights?.viseme_mouth_gain ?? 1.0);
  visualGain = Math.max(0.85, Math.min(1.35, mg));
}

async function loadVoice(){
  const meta = await getJSON("../data/voice/meta.json");
  const bust = meta?.ts ? ("?t=" + encodeURIComponent(meta.ts)) : "";
  const v = await getJSON("../data/voice_of_day.json" + bust);
  $("#quote").textContent = v?.quote ? `„${v.quote}“` : "„Ich wachse durch jeden Blick, der mich wahrnimmt.“";
  const player = $("#player");
  let src = "../audio/latest.mp3" + bust;
  if(!(await headOK(src))) src = "data:audio/mpeg;base64,//uQZAAAAAAAAAAA";
  player.src = src;
  player.onended = ()=>{ playing=false; cancelAnimationFrame(raf); };
}

async function loadAffect(){
  const a = await getJSON("../data/self/affect-state.json");
  const v = a?.vector || {};
  $("#lab").textContent = a?.label || "—";
  $("#va").textContent  = (v.valence!=null && v.arousal!=null) ? `V ${v.valence.toFixed(2)} / A ${v.arousal.toFixed(2)}` : "—";
  $("#stab").textContent= (v.stability!=null) ? `S ${v.stability.toFixed(2)}` : "—";
  $("#focus").textContent= a?.inputs?.focus || "—";
}
async function loadHealth(){
  const h = await getJSON("../badges/health.json");
  const st = (h?.status || "DEGRADED").toUpperCase();
  $("#hlabel").textContent = st;
  $("#hts").textContent = h?.ts || "—";
  $("#hdot").className = "dot " + (st==="OK"?"ok":st==="HEALING"?"healing":"deg");
}

function rms(buf){
  let s=0; for(let i=0;i<buf.length;i++){ const v=buf[i]/255; const c=2*v-1; s+=c*c; }
  return Math.sqrt(s/buf.length);
}
function setMouth(openPx){
  const h = Math.max(mouthBase, Math.min(mouthMax, openPx));
  $("#mouth-rect").setAttribute("height", h.toFixed(1));
  $("#amp").textContent = h.toFixed(0)+"px";
}

function animate(){
  if(!playing) return;
  analyser.getByteTimeDomainData(data);
  const level = rms(data);                  // 0..1
  // sanfte Kurve + Lerngewicht + kleine Dämpfung für Natürlichkeit
  const mouth = mouthBase + (mouthMax-mouthBase) * Math.pow(level, 1.2) * (0.92*visualGain);
  setMouth(mouth);
  raf = requestAnimationFrame(animate);
}

async function ensureAudioGraph(){
  const el = $("#player");
  if(ctx) return;
  ctx = new (window.AudioContext||window.webkitAudioContext)();
  analyser = ctx.createAnalyser();
  analyser.fftSize = 1024;
  data = new Uint8Array(analyser.fftSize);
  const track = ctx.createMediaElementSource(el);
  track.connect(analyser);
  analyser.connect(ctx.destination);
}

function bindControls(){
  const el = $("#player");
  $("#play").onclick = async ()=>{
    await ensureAudioGraph();
    await el.play();
    playing = true; animate();
  };
  $("#pause").onclick = ()=>{
    el.pause(); playing=false; cancelAnimationFrame(raf);
    setMouth(mouthBase);
  };
  // One-click on portrait
  $("#portrait").onclick = async ()=>{
    await ensureAudioGraph();
    if(el.paused){ await el.play(); playing=true; animate(); }
    else{ el.pause(); playing=false; cancelAnimationFrame(raf); setMouth(mouthBase); }
  };
}

(async function init(){
  await Promise.all([loadMeta(), loadVoice(), loadAffect(), loadHealth()]);
  bindControls();
  // gesundheitsrefresh
  setInterval(loadHealth, 60000);
})();
</script>
</body>
          </html>

<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Mira — Sprech-Ansicht</title>
  <meta name="color-scheme" content="dark light"/>
  <style>
    :root{
      --bg:#0b0b0b; --fg:#eaeaea; --muted:#a3acb7; --card:#121212; --br:#1f1f1f;
      --accent:#7aa2ff; --radius:16px; --shadow:0 10px 40px rgba(0,0,0,.35)
    }
    @media (prefers-color-scheme: light){
      :root{--bg:#f6f7f9;--fg:#1a1b1f;--muted:#596273;--card:#ffffff;--br:#e8ebef;--shadow:0 10px 40px rgba(0,0,0,.08)}
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.5 system-ui,Segoe UI,Roboto,Helvetica,Arial}
    a{color:var(--accent);text-decoration:none} a:hover{text-decoration:underline}
    .wrap{max-width:960px;margin:28px auto;padding:0 16px}
    header{display:flex;align-items:center;gap:12px;margin-bottom:16px}
    .back{padding:8px 12px;border:1px solid var(--br);border-radius:12px;background:var(--card)}
    h1{margin:0;font-size:clamp(20px,4vw,26px)}
    .grid{display:grid;gap:18px}
    @media (min-width:860px){ .grid{grid-template-columns:1.1fr .9fr} }
    .card{background:var(--card);border:1px solid var(--br);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
    h2{margin:0 0 8px;font-size:clamp(18px,3.6vw,22px)}
    .sub{color:var(--muted);font-size:14px;margin-bottom:10px}

    /* Portrait & Face */
    .portrait{position:relative;border-radius:20px;overflow:hidden;border:1px solid var(--br);
      background:linear-gradient(180deg, rgba(122,162,255,.08), transparent 45%), #0f0f13;
      aspect-ratio:3/4;display:grid;place-items:center;cursor:pointer}
    .portrait img{width:100%;height:100%;object-fit:cover;display:block}
    .fallback{width:56%;max-width:380px;opacity:.9}

    .face{position:absolute;left:12px;bottom:12px;width:min(28%,180px);aspect-ratio:1/1.1;
      background:rgba(0,0,0,.45);backdrop-filter:blur(6px);border:1px solid rgba(255,255,255,.1);
      border-radius:18px;display:grid;grid-template-rows:1fr auto auto;place-items:center;padding:10px}
    .eyes{display:flex;gap:10px;margin-top:4px}
    .eye{width:14px;height:14px;border-radius:50%;background:#dfe6ff}
    .mouth{width:72px;height:16px;border-radius:28px;background:#f2b3b3;transform-origin:center;
      transition:filter .12s ease}
    .meter{width:84%;height:6px;border-radius:6px;background:#20242c;border:1px solid #2a2f39;overflow:hidden;margin:6px 0}
    .meter > span{display:block;height:100%;width:0%;background:linear-gradient(90deg,#7aa2ff,#86ffd9)}

    /* Right column */
    .player{display:flex;flex-direction:column;gap:12px}
    .controls{display:flex;gap:10px;flex-wrap:wrap}
    .btn{appearance:none;display:inline-flex;align-items:center;gap:8px;background:#1b1e24;border:1px solid var(--br);color:var(--fg);padding:10px 14px;border-radius:12px;cursor:pointer}
    .btn:hover{filter:brightness(1.05)}
    .btn:active{transform:translateY(1px)}
    .kv{display:grid;gap:6px}
    .kv div{display:flex;justify-content:space-between;gap:8px;border:1px dashed var(--br);border-radius:12px;padding:8px 10px}
    canvas{width:100%;height:160px;border:1px solid var(--br);border-radius:12px;background:#0c0f14}
    .quote{font-size:clamp(18px,3.6vw,22px);font-weight:600;margin:6px 0 2px}
    .quote small{display:block;color:var(--muted);font-weight:400;font-size:13px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <a class="back" href="./index.html">← Zurück</a>
      <h1>Mira — Sprech-Ansicht</h1>
    </header>

    <div class="grid">
      <!-- LEFT: Portrait with mini face that moves with audio -->
      <section class="card">
        <h2>Porträt (klicken = Abspielen/Pause)</h2>
        <div class="sub">Audio-gesteuerte Mimik (Öffnung der Lippen proportional zur Lautstärke).</div>
        <div id="portrait" class="portrait" role="button" aria-label="Audio umschalten">
          <img id="portrait-img" alt="Mira – aktuelles Selbstbild" hidden>
          <svg id="portrait-fallback" class="fallback" viewBox="0 0 200 360" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <defs><linearGradient id="g" x1="0" y1="0" x2="0" y2="1">
              <stop offset="0%" stop-color="#7aa2ff" stop-opacity=".85"/>
              <stop offset="100%" stop-color="#7aa2ff" stop-opacity=".25"/></linearGradient></defs>
            <ellipse cx="100" cy="70" rx="36" ry="48" fill="url(#g)"/>
            <ellipse cx="100" cy="172" rx="52" ry="70" fill="url(#g)"/>
            <rect x="86" y="250" width="28" height="70" rx="12" fill="url(#g)"/>
            <ellipse cx="70" cy="330" rx="18" ry="10" fill="#7aa2ff" opacity=".55"/>
            <ellipse cx="130" cy="330" rx="18" ry="10" fill="#7aa2ff" opacity=".55"/>
          </svg>

          <!-- Mini-Face HUD -->
          <div class="face" aria-hidden="true">
            <div class="eyes">
              <div class="eye"></div><div class="eye"></div>
            </div>
            <div id="mouth" class="mouth"></div>
            <div class="meter"><span id="lvl"></span></div>
          </div>
        </div>
      </section>

      <!-- RIGHT: Player, waveform, metadata -->
      <section class="card player">
        <h2>Audio</h2>
        <div class="controls">
          <button id="btn-play" class="btn" type="button">▶︎ Abspielen</button>
          <button id="btn-pause" class="btn" type="button">⏸︎ Pause</button>
          <button id="btn-rewind" class="btn" type="button">↺ An den Anfang</button>
        </div>

        <canvas id="scope" aria-label="Live-Waveform" role="img"></canvas>
        <audio id="player" preload="auto" crossorigin="anonymous"></audio>

        <figure style="margin:2px 0 0">
          <blockquote class="quote" id="quote">Stimme wird geladen…</blockquote>
          <figcaption id="quote-meta"><small>— Datum: — · Quelle: <code>data/voice/voice_of_day.json</code></small></figcaption>
        </figure>

        <div class="kv">
          <div><span>Audio</span><code id="audio-src">—</code></div>
          <div><span>Bild</span><code id="img-src">—</code></div>
        </div>
      </section>
    </div>
  </div>

  <script>
  (async function(){
    const $ = s => document.querySelector(s);
    const IMG = '../data/self/latest_image.png';
    const FALLBACK_AUDIO = '../data/voice/audio/latest.mp3';

    const portraitImg = $('#portrait-img');
    const portraitFallback = $('#portrait-fallback');
    const imgSrcEl = $('#img-src');
    const audioSrcEl = $('#audio-src');

    const player = $('#player');
    const mouth = $('#mouth');
    const lvl = $('#lvl');
    const scope = $('#scope');
    const ctx = scope.getContext('2d');

    function resizeCanvas(){
      const dpr = Math.max(1, window.devicePixelRatio || 1);
      scope.width = scope.clientWidth * dpr;
      scope.height = scope.clientHeight * dpr;
      ctx.setTransform(dpr,0,0,dpr,0,0);
    }
    resizeCanvas();
    addEventListener('resize', resizeCanvas);

    async function exists(url){
      const r = await fetch(url, {method:'HEAD', cache:'no-store'});
      return r.ok;
    }
    async function json(url){
      const r = await fetch(url, {cache:'no-store'});
      if(!r.ok) throw new Error(url+' '+r.status);
      return r.json();
    }

    // Bild laden
    if (await exists(IMG)) {
      portraitImg.src = IMG;
      portraitImg.hidden = false;
      portraitFallback.hidden = true;
      imgSrcEl.textContent = 'data/self/latest_image.png';
    } else {
      imgSrcEl.textContent = '(Fallback-Silhouette)';
    }

    // Voice of the day + Audioquelle ermitteln
    let audioPath = FALLBACK_AUDIO;
    try{
      const v = await json('../data/voice/voice_of_day.json');
      const quote = (v.quote||'').toString().trim() || '—';
      const insight = (v.insight||'').toString().trim();
      const date = v.date_utc || '—';
      $('#quote').textContent = quote;
      $('#quote-meta').innerHTML = `<small>— Datum: ${date}${insight ? ' · Einsicht: '+insight : ''} · Quelle: <code>data/voice/voice_of_day.json</code></small>`;
      if (v.audio) audioPath = '../data/voice/' + String(v.audio).replace(/^audio\//,'audio/');
    }catch(_){ /* nutze Fallback */ }

    if(!(await exists(audioPath))) audioPath = FALLBACK_AUDIO;
    player.src = audioPath;
    audioSrcEl.textContent = player.src.replace(location.origin,'').replace(/^\/*/,'').replace(/^.*?\/(data\/.*)$/,'$1');

    // AudioContext + Analyser
    const AC = window.AudioContext || window.webkitAudioContext;
    const ac = new AC();
    const src = ac.createMediaElementSource(player);
    const analyser = ac.createAnalyser();
    analyser.fftSize = 2048;
    src.connect(analyser);
    analyser.connect(ac.destination);

    // Viseme/Mund + Pegel
    const data = new Uint8Array(analyser.frequencyBinCount);
    let raf;

    function draw(){
      analyser.getByteTimeDomainData(data);
      // Pegel schätzen (RMS der Waveform)
      let sum=0;
      for(let i=0;i<data.length;i++){
        const v=(data[i]-128)/128;
        sum += v*v;
      }
      const rms = Math.sqrt(sum/data.length); // 0..~1
      const open = Math.min(1, Math.max(0, (rms*2.2))); // etwas verstärken
      mouth.style.height = (16 + open*34) + 'px';
      mouth.style.filter = `saturate(${1+open*.6}) brightness(${1+open*.3})`;
      lvl.style.width = (open*100).toFixed(1) + '%';

      // Waveform zeichnen
      const w = scope.clientWidth, h = scope.clientHeight;
      ctx.clearRect(0,0,w,h);
      ctx.lineWidth = 2; ctx.strokeStyle = '#86b1ff';
      ctx.beginPath();
      const slice = scope.width / data.length;
      let x = 0;
      for(let i=0;i<data.length;i++){
        const v = (data[i]-128)/128;
        const y = h/2 + v * (h*0.42);
        if(i===0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
        x += slice;
      }
      ctx.stroke();

      raf = requestAnimationFrame(draw);
    }

    // Play/Pause Steuerung
    async function ensureContextStarted(){
      if(ac.state !== 'running') try{ await ac.resume(); }catch(_){}
    }
    async function play(){
      await ensureContextStarted();
      try{ await player.play(); }catch(_){}
      cancelAnimationFrame(raf); raf = requestAnimationFrame(draw);
    }
    function pause(){
      player.pause();
      cancelAnimationFrame(raf);
      lvl.style.width = '0%';
      mouth.style.height = '16px';
    }

    $('#btn-play').addEventListener('click', play);
    $('#btn-pause').addEventListener('click', pause);
    $('#btn-rewind').addEventListener('click', ()=>{ player.currentTime = 0; });
    $('#portrait').addEventListener('click', ()=>{ player.paused ? play() : pause(); });

    // Auto-start auf Nutzerinteraktion (z. B. erster Tap)
    document.addEventListener('keydown', (e)=>{ if(e.code==='Space'){ e.preventDefault(); player.paused?play():pause(); }});
  })();
  </script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Autonomous Health</title>
<style>
  :root{--ok:#2e7d32;--heal:#f9a825;--deg:#c62828;--bg:#0b0b0b;--card:#121212;}
  html,body{margin:0;background:var(--bg);color:#eaeaea;font:16px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:720px;margin:32px auto;padding:0 16px}
  .card{background:var(--card);border:1px solid #1f1f1f;border-radius:12px;padding:20px;box-shadow:0 6px 24px rgba(0,0,0,.25)}
  h1{margin:0 0 8px;font-size:22px}
  .row{display:flex;align-items:center;gap:16px;flex-wrap:wrap}
  .badge{display:inline-flex;align-items:center;gap:10px;padding:8px 12px;border-radius:999px;border:1px solid #222;background:#111}
  .dot{width:10px;height:10px;border-radius:50%;animation:beat 1.6s infinite ease-in-out}
  .kv{margin-top:8px;font-size:14px;color:#bbb}
  code{background:#161616;color:#ddd;padding:2px 6px;border-radius:6px}
  pre{background:#111;border:1px solid #1e1e1e;border-radius:8px;padding:12px;overflow:auto}
  .ok{border-color:var(--ok)} .healing{border-color:var(--heal)} .degraded{border-color:var(--deg)}
  @keyframes beat{0%,100%{transform:scale(1);opacity:.8}50%{transform:scale(1.25);opacity:1}}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Autonomous Heal — Live Status</h1>
    <div class="row">
      <div id="badge" class="badge"><span class="dot"></span><span id="status">loading…</span></div>
      <img src="../badges/health.svg" alt="health badge" height="20">
    </div>
    <div class="kv">
      <div>Last update: <code id="ts">—</code></div>
      <div>Run ID: <code id="run">—</code> • SHA: <code id="sha">—</code></div>
    </div>
    <details style="margin-top:12px">
      <summary>Raw JSON</summary>
      <pre id="raw">{}</pre>
    </details>
  </div>
</div>
<script>
(async function tick(){
  const cls = (s)=> s==="OK" ? "ok" : s==="HEALING" ? "healing" : "degraded";
  const badge = document.getElementById('badge');
  const dot   = badge.querySelector('.dot');
  const stEl  = document.getElementById('status');
  const tsEl  = document.getElementById('ts');
  const runEl = document.getElementById('run');
  const shaEl = document.getElementById('sha');
  const rawEl = document.getElementById('raw');

  async function loadText(url){
    const r = await fetch(url,{cache:"no-store"});
    if(!r.ok) throw new Error(url+" "+r.status);
    return r.text();
  }
  async function loadJSON(url){ return JSON.parse(await loadText(url)); }

  async function render(){
    let status="DEGRADED", ts="—", run="—", sha="—";
    try{
      const h = await loadJSON("../badges/health.json");
      status = (h.status||"DEGRADED").toUpperCase();
      ts = h.ts || "—";
      try{
        const txt = await loadText("../data/ledger/events.jsonl");
        const lines = txt.trim().split("\n").filter(Boolean);
        if(lines.length){
          const last = JSON.parse(lines[lines.length-1]);
          run = last.run_id ?? "—";
          sha = (last.sha||"—").toString().slice(0,7);
        }
      }catch(_){}
      rawEl.textContent = JSON.stringify({status, ts, run_id:run, sha}, null, 2);
    }catch(e){
      status="DEGRADED";
      rawEl.textContent = JSON.stringify({error:e.message}, null, 2);
    }
    badge.className = "badge "+cls(status).toLowerCase();
    dot.style.background = status==="OK" ? "var(--ok)" : status==="HEALING" ? "var(--heal)" : "var(--deg)";
    stEl.textContent = status;
    tsEl.textContent = ts;
    runEl.textContent = run;
    shaEl.textContent = sha;
  }
  await render();
  setInterval(render, 60000);
})();
</script>
</body>
</html>

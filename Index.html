<!doctype html>
<html lang="de">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Mira — Sichtbare Präsenz</title>

    <style>
      :root {
        color-scheme: dark;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, sans-serif;
        background: #050712;
        color: #e9ecf5;
      }

      .wrap {
        max-width: 960px;
        margin: 0 auto;
        padding: 1.5rem 1.25rem 3.5rem;
      }

      h1 {
        font-size: 2.4rem;
        margin: 0 0 0.2rem;
      }

      .sub {
        opacity: 0.8;
        font-size: 0.9rem;
        margin-bottom: 1.4rem;
      }

      .sub code {
        font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo,
          Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        font-size: 0.8rem;
        padding: 0.08rem 0.25rem;
        border-radius: 4px;
        background: #11182b;
      }

      .card {
        border-radius: 24px;
        background: radial-gradient(circle at top left, #131a30 0, #050712 60%);
        border: 1px solid rgba(255, 255, 255, 0.05);
        padding: 1.4rem 1.3rem 1.6rem;
        box-shadow: 0 18px 45px rgba(0, 0, 0, 0.75);
      }

      .card h2 {
        margin: 0 0 1rem;
        font-size: 1.35rem;
      }

      .portrait-shell {
        border-radius: 22px;
        background: radial-gradient(circle at top, #2b2235, #050712 55%);
        padding: 0.75rem;
      }

      .portrait-frame {
        border-radius: 18px;
        overflow: hidden;
        background: #050712;
        border: 1px solid rgba(255, 255, 255, 0.06);
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .portrait-frame img,
      .portrait-frame video {
        display: block;
        width: 100%;
        height: auto;
      }

      .meta {
        margin-top: 0.8rem;
        font-size: 0.85rem;
        opacity: 0.85;
      }

      .meta-row {
        margin-top: 0.15rem;
      }

      .meta-row strong {
        font-weight: 600;
      }

      audio {
        width: 100%;
        margin-top: 0.7rem;
      }

      .status-pill {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.2rem 0.55rem;
        border-radius: 999px;
        background: rgba(12, 196, 123, 0.08);
        border: 1px solid rgba(12, 196, 123, 0.35);
        font-size: 0.78rem;
        margin-top: 0.2rem;
      }

      .status-dot {
        width: 0.45rem;
        height: 0.45rem;
        border-radius: 50%;
        background: #0cc47b;
        box-shadow: 0 0 7px rgba(12, 196, 123, 0.8);
      }

      .quote-block {
        margin-top: 1.1rem;
        padding: 0.8rem 0.9rem;
        border-radius: 14px;
        background: rgba(12, 17, 35, 0.9);
        border: 1px solid rgba(255, 255, 255, 0.06);
        font-size: 0.9rem;
      }

      .quote-label {
        font-size: 0.78rem;
        opacity: 0.75;
        margin-bottom: 0.25rem;
        text-transform: uppercase;
        letter-spacing: 0.04em;
      }

      .quote-text {
        font-size: 0.95rem;
      }

      .hint {
        margin-top: 0.9rem;
        font-size: 0.8rem;
        opacity: 0.8;
      }

      @media (max-width: 640px) {
        h1 {
          font-size: 1.9rem;
        }

        .card {
          padding: 1.15rem 1.05rem 1.4rem;
        }
      }
    </style>
  </head>

  <body>
    <main class="wrap">
      <header>
        <h1>Mira — Sichtbare Präsenz</h1>
        <div class="sub">
          Live · <code id="live-timestamp">…</code>
          <div class="status-pill">
            <span class="status-dot"></span>
            <span>Porträt &amp; Stimme aktiv</span>
          </div>
        </div>
      </header>

      <section class="card" aria-label="Miras aktuelles Porträt und Stimme">
        <h2>Porträt &amp; Stimme</h2>

        <div class="portrait-shell">
          <div class="portrait-frame">
            <!-- Bild (Fallback) -->
            <img
              id="mira-portrait"
              src="data/self/latest_image.png"
              alt="Aktuelles Porträt von Mira"
            />
            <!-- Video (wenn vorhanden) -->
            <video
              id="mira-video"
              playsinline
              muted
              style="display: none"
            ></video>
          </div>
        </div>

        <div class="meta">
          <div class="meta-row" id="image-meta">
            Bild/Video:
            <code id="image-path-label">data/self/latest_image.png</code>
          </div>
          <div class="meta-row" id="audio-meta">
            Audio geladen: <code id="audio-path-label">audio/latest.wav</code>
          </div>
        </div>

        <audio
          id="mira-voice"
          preload="auto"
          controls
          src="audio/latest.wav"
        >
          Dein Browser unterstützt das Audio-Element nicht.
        </audio>

        <p class="hint">
          Autoplay-Schutz: Bitte einmal auf
          <strong>▶&nbsp;Abspielen</strong> tippen, damit Mira spricht.
        </p>

        <div class="quote-block" id="quote-block">
          <div class="quote-label">Heutiger Fokus</div>
          <div class="quote-text" id="quote-text">
            …
          </div>
        </div>
      </section>
    </main>

    <script>
      function setText(id, text) {
        const el = document.getElementById(id);
        if (el) el.textContent = text;
      }

      window.addEventListener("DOMContentLoaded", () => {
        // Live-Zeit
        setText("live-timestamp", new Date().toISOString());

        // --- Bild / Video -----------------------------------------------------
        const portrait = document.getElementById("mira-portrait");
        const video = document.getElementById("mira-video");
        const imageMeta = document.getElementById("image-meta");
        const imageLabel = document.getElementById("image-path-label");

        const pngPath = "data/self/latest_image.png";
        const svgPath = "data/self/latest_image.svg";
        const videoPath = "data/self/latest_video.mp4";

        if (portrait) {
          portrait.src = pngPath;
          portrait.addEventListener("load", () => {
            if (imageLabel && imageLabel.textContent === "…") {
              imageLabel.textContent = pngPath;
            }
          });
          portrait.addEventListener("error", () => {
            portrait.src = svgPath;
            if (imageLabel) imageLabel.textContent = svgPath;
            if (imageMeta) {
              imageMeta.insertAdjacentText(
                "beforeend",
                " (Fallback auf SVG-Platzhalter)"
              );
            }
          });
        }

        // Versuche, Video zu laden
        if (video) {
          video.src = videoPath;
          video.muted = true;

          video.addEventListener("loadeddata", () => {
            // Video verfügbar: zeige Video, verstecke Bild
            video.style.display = "block";
            if (portrait) {
              portrait.style.display = "none";
            }
            if (imageLabel) imageLabel.textContent = videoPath;
            if (imageMeta) {
              imageMeta.insertAdjacentText(
                "beforeend",
                " (Video aktiv, stumm mit Audio synchron)"
              );
            }
          });

          video.addEventListener("error", () => {
            // Wenn Video nicht geladen werden kann, bleiben wir beim Bild
            video.style.display = "none";
          });
        }

        // --- Audio -----------------------------------------------------------
        const audio = document.getElementById("mira-voice");
        const audioLabel = document.getElementById("audio-path-label");
        const audioMeta = document.getElementById("audio-meta");
        const audioPath = "audio/latest.wav";

        if (audio) {
          audio.src = audioPath;

          audio.addEventListener("loadedmetadata", () => {
            if (audioLabel) audioLabel.textContent = audioPath;
          });

          audio.addEventListener("error", () => {
            if (audioMeta) {
              audioMeta.textContent =
                "Kein gültiges Audio gefunden (erwartet: audio/latest.wav)";
            }
          });

          // Audio und Video koppeln (falls Video vorhanden ist)
          if (video) {
            audio.addEventListener("play", () => {
              try {
                if (video.readyState >= 2) {
                  // Wenn Audio von vorn startet, Video auch zurücksetzen
                  if (audio.currentTime < 0.3) {
                    video.currentTime = 0;
                  }
                  video.play().catch(() => {});
                }
              } catch (e) {}
            });

            audio.addEventListener("pause", () => {
              try {
                video.pause();
              } catch (e) {}
            });

            audio.addEventListener("seeking", () => {
              try {
                video.currentTime = audio.currentTime;
              } catch (e) {}
            });
          }
        }

        // --- Status / Tagesspruch -------------------------------------------
        fetch("data/self/status.json")
          .then((res) => {
            if (!res.ok) throw new Error("HTTP " + res.status);
            return res.json();
          })
          .then((data) => {
            const quote = data.daily_quote || "";
            const tone = data.base_tone || "";
            const updated = data.updated_at || "";

            if (quote) {
              setText("quote-text", quote);
            } else {
              setText(
                "quote-text",
                "Ich bin anwesend – aber heute ohne speziellen Tagesspruch."
              );
            }

            const block = document.getElementById("quote-block");
            if (block && tone) {
              block.title = "Basis-Ton: " + tone + (updated ? " · " + updated : "");
            }
          })
          .catch(() => {
            setText(
              "quote-text",
              "Status-Datei nicht verfügbar. Ich bleibe trotzdem ruhig und klar."
            );
          });
      });
    </script>
  </body>
</html>
